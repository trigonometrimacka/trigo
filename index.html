<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TRIGO AI - AkÄ±llÄ± YÃ¼kseklik Ã–lÃ§er</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Audiowide&family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* Projeye Ã¶zel stiller */
        body { 
            font-family: 'Inter', sans-serif; 
            touch-action: manipulation;
            overscroll-behavior: none;
            /* Ana metin rengi 'beyaz' (hafif kÄ±rÄ±k) */
            color: #E5E7EB; /* gray-200 */
        }

        /* Logo iÃ§in Ã¶zel font sÄ±nÄ±fÄ± (Audiowide) */
        .font-logo {
            font-family: 'Audiowide', sans-serif;
            letter-spacing: 1.5px;
        }
        
        /* Dinamik AltÄ±n Rengi */
        .color-gold {
            color: rgb(229, 174, 50);
        }
        
        /* NiÅŸangah (Crosshair) Stili - AltÄ±n Rengi */
        .crosshair {
            position: relative;
            width: 150px;
            height: 150px;
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            margin: 20px auto;
        }
        /* Dikey Ã§izgi (Sabit) */
        .crosshair-line-v {
            position: absolute;
            top: 50%;
            left: calc(50% - 1px);
            height: 50px;
            width: 2px;
            background: rgba(229, 174, 50, 0.7);
            box-shadow: 0 0 8px rgba(229, 174, 50, 1);
            transform: translateY(-50%);
        }
        /* Yatay Ã§izgi (DÄ°NAMÄ°K) */
        .crosshair-line-h {
            position: absolute;
            left: 50%;
            top: 50%; 
            width: 50px;
            height: 2px;
            background: rgba(229, 174, 50, 0.7);
            box-shadow: 0 0 8px rgba(229, 174, 50, 1);
            transform: translateX(-50%) translateY(-1px); 
            transition: transform 0.1s linear; 
        }

        /* Number input'lardaki oklarÄ± gizle */
        input[type="number"] {
            -moz-appearance: textfield;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        /* Aktif sekme stili - AltÄ±n Rengi */
        .tab-btn.active {
            background-color: rgb(229, 174, 50);
            color: black;
        }
        
        /* Yeni: Select element stili */
        select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2020%2020%22%20fill%3D%22white%22%3E%3Cpath%20d%3D%22M5.293%207.293a1%201%200%20011.414%200L10%2010.586l3.293-3.293a1%201%200%20111.414%201.414l-4%204a1%201%200%2001-1.414%200l-4-4a1%201%200%20010-1.414z%22%20clip-rule%3D%22evenodd%22%20fill-rule%3D%22evenodd%22%3E%3C%2Fpath%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
    </style>
</head>
<body class="bg-gray-900 flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-md mx-auto">

        <div id="setup-screen" class="bg-gradient-to-br from-gray-900 to-gray-800 p-6 rounded-2xl shadow-2xl transition-all duration-300 ring-1 ring-gray-700">
            <div class="text-center mb-6">
                <h1 class="font-logo text-5xl font-bold color-gold mb-1">TRIGO AI</h1>
                <p class="text-lg text-gray-300">AkÄ±llÄ± YÃ¼kseklik AsistanÄ±</p>
            </div>
            
            <div class="flex mb-4 rounded-lg bg-gray-700 p-1 text-sm">
                <button class="tab-btn flex-1 p-2 rounded-md font-semibold transition-all active" data-tab="tab-input">
                    GiriÅŸ
                </button>
                <button class="tab-btn flex-1 p-2 rounded-md font-semibold transition-all text-gray-400" data-tab="tab-simple">
                    Basit AnlatÄ±m
                </button>
                <button class="tab-btn flex-1 p-2 rounded-md font-semibold transition-all text-gray-400" data-tab="tab-purpose">
                    Proje AmacÄ±
                </button>
                <button class="tab-btn flex-1 p-2 rounded-md font-semibold transition-all text-gray-400" data-tab="tab-how">
                    NasÄ±l Ã‡alÄ±ÅŸÄ±r?
                </button>
            </div>

            <div id="tab-content">
                <div id="tab-input" class="tab-panel">
                    <p class="text-sm text-gray-400 mb-4">LÃ¼tfen Ã¶lÃ§Ã¼m yapmak iÃ§in aÅŸaÄŸÄ±daki bilgileri girin:</p>
                    
                    <div class="mb-4">
                        <label for="distance" class="block text-sm font-medium text-gray-300 mb-1">1. Cisme Yatay UzaklÄ±k</label>
                        
                        <div class="flex space-x-2">
                            <input type="number" id="distance" value="10" class="w-2/3 p-3 bg-gray-700 border border-gray-600 rounded-lg text-white text-lg focus:ring-2 focus:ring-[rgb(229,174,50)] focus:outline-none" placeholder="Ã–rn: 10">
                            <select id="distanceUnit" class="w-1/3 p-3 bg-gray-700 border border-gray-600 rounded-lg text-white text-lg focus:ring-2 focus:ring-[rgb(229,174,50)] focus:outline-none">
                                <option value="m">metre (m)</option>
                                <option value="mm">milimetre (mm)</option>
                            </select>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">GirdiÄŸiniz birim, hesaplama Ã¶ncesinde metreye Ã§evrilecektir.</p>
                    </div>

                    <div class="mb-6">
                        <label for="userHeight" class="block text-sm font-medium text-gray-300 mb-1">2. Cihaz YÃ¼ksekliÄŸi (metre)</label>
                        <input type="number" id="userHeight" value="1.7" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white text-lg focus:ring-2 focus:ring-[rgb(229,174,50)] focus:outline-none" placeholder="Ã–rn: 1.7">
                        <p class="text-xs text-gray-500 mt-1">Telefonu tuttuÄŸunuz yÃ¼kseklik (gÃ¶z hizanÄ±z).</p>
                    </div>

                    <button id="startButton" class="w-full bg-[rgb(229,174,50)] text-black p-4 rounded-lg font-bold text-lg hover:bg-[rgb(209,154,30)] transition-all duration-200 shadow-lg active:scale-95">
                        Ã–lÃ§Ã¼mÃ¼ BaÅŸlat
                    </button>
                    <p id="permission-status" class="text-center color-gold text-sm mt-4 h-5"></p>
                </div>

                <div id="tab-simple" class="tab-panel hidden text-gray-300 text-sm space-y-3">
                    <h3 class="font-semibold text-lg text-white mb-2">Bu Alet Ne Ä°ÅŸe YarÄ±yor? (Mala AnlatÄ±r Gibi)</h3>
                    <p>Diyelim karÅŸÄ±daki binanÄ±n boyunu merak ettin. Bu alet, telefonunu **sÃ¼per akÄ±llÄ± bir metreye** dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r.</p>
                    <p>Olay basit:</p>
                    <ul class="list-disc list-outside space-y-2 pl-5">
                        <li>
                            <strong class="text-white">1. UzaklÄ±ÄŸÄ± SÃ¶yle:</strong> Sen programa "Ben binadan 15 metre uzaktayÄ±m" diyorsun.
                        </li>
                        <li>
                            <strong class="text-white">2. NiÅŸan Al:</strong> Telefonunu binanÄ±n <strong class="color-gold">tepesine</strong> doÄŸrultuyorsun.
                        </li>
                        <li>
                            <strong class="text-white">3. Bitti:</strong> Program, telefonu ne kadar <strong class="color-gold">yukarÄ±</strong> kaldÄ±rdÄ±ÄŸÄ±nÄ± anlÄ±yor, basit bir matematik yapÄ±yor ve "O BÄ°NA 25 METREYMÄ°Å" diyor.
                        </li>
                    </ul>
                    <p class="font-medium text-gray-400 mt-3">"AI" (Yapay ZekÃ¢) ise senin <strong class="text-white">el titremeni</strong> yok sayÄ±p Ã¶lÃ§Ã¼mÃ¼ tertemiz yapÄ±yor. O kadar.</p>
                </div>

                <div id="tab-purpose" class="tab-panel hidden text-gray-300 text-sm space-y-3">
                    <h3 class="font-semibold text-lg text-white mb-2">Trigonometri GÃ¶z HizanÄ±zda</h3>
                    <p>TRIGO AI, bir binanÄ±n, bir aÄŸacÄ±n veya herhangi bir yÃ¼ksek nesnenin boyunu Ã¶lÃ§mek iÃ§in telefonunuzun sensÃ¶rlerini ve temel trigonometriyi kullanÄ±r.</p>
                    <p>AmacÄ±mÄ±z, matematiÄŸi kaÄŸÄ±t Ã¼zerindeki bir formÃ¼l olmaktan Ã§Ä±karÄ±p, onu herkesin kullanabileceÄŸi, AI (Yapay ZekÃ¢) destekli pratik bir Ã¶lÃ§Ã¼m aracÄ±na dÃ¶nÃ¼ÅŸtÃ¼rmektir.</p>
                    <p class="font-medium color-gold">Ekstra bir lazermetre veya donanÄ±ma gerek yok; sadece telefonunuz yeterli.</p>
                </div>
                
                <div id="tab-how" class="tab-panel hidden text-gray-300 text-sm space-y-3">
                    <h3 class="font-semibold text-lg text-white mb-2">HayatÄ± KolaylaÅŸtÄ±ran FormÃ¼l</h3>
                    <p>Sizden tek istediÄŸimiz, Ã¶lÃ§tÃ¼ÄŸÃ¼nÃ¼z nesneye olan yatay uzaklÄ±ÄŸÄ±nÄ±zÄ± ($d$) bilmeniz.</p>
                    <p>Siz hedefin tepesine niÅŸan aldÄ±ÄŸÄ±nÄ±zda, telefonunuzun eÄŸim sensÃ¶rÃ¼ (jiroskop) $\beta$ (beta) aÃ§Ä±sÄ±nÄ± Ã¶lÃ§er.</p>
                    <p>Uygulama, bu iki bilgiyi kullanarak anÄ±nda o meÅŸhur formÃ¼lÃ¼ uygular:</p>
                    <div class="text-center bg-gray-800 p-3 rounded-lg my-2">
                        <code class="text-base color-gold">YÃ¼kseklik = tan(Î²) Ã— UzaklÄ±k (d)</code>
                    </div>
                    <p>AI'nÄ±n rolÃ¼ ise, el titremesi gibi sensÃ¶r hatalarÄ±nÄ± filtreleyerek $\beta$ aÃ§Ä±sÄ±nÄ± stabilize etmek ve size en doÄŸru sonucu sunmaktÄ±r.</p>
                </div>
            </div>
        </div>

        <div id="measurement-screen" class="hidden bg-gradient-to-br from-gray-900 to-gray-800 p-6 md:p-8 rounded-2xl shadow-2xl text-center transition-all duration-300 ring-1 ring-gray-700">
            
            <p id="liveMeasurementHeader" class="text-sm text-gray-400 mb-2">Cismin tepesine niÅŸan alÄ±n</p>
            
            <div id="liveDisplayArea">
                <div class="crosshair">
                    <div id="crosshair-h" class="crosshair-line-h"></div>
                    <div class="crosshair-line-v"></div>
                </div>

                <h2 class="text-gray-400 text-lg font-semibold uppercase tracking-wider">Tahmini YÃ¼kseklik</h2>
                <div id="heightDisplay" class="text-6xl font-extrabold text-white my-2">0.00 m</div>
                
                <div class="flex justify-around bg-gray-950 rounded-lg p-4 my-4 ring-1 ring-gray-700">
                    <div>
                        <div class="text-xs color-gold uppercase">EÄŸim AÃ§Ä±sÄ± (Î²)</div>
                        <div id="angleDisplay" class="text-2xl font-bold text-white">0.0Â°</div>
                    </div>
                    <div>
                        <div class="text-xs color-gold uppercase">KararlÄ±lÄ±k</div>
                        <div id="stabilityDisplay" class="text-2xl font-bold text-white">--%</div>
                    </div>
                </div>

                <div class="w-full bg-gray-700 rounded-full h-2.5 mb-4 overflow-hidden">
                    <div id="stabilityBar" class="bg-[rgb(229,174,50)] h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                
                <div class="bg-gray-700 p-3 rounded-lg min-h-[50px] flex items-center justify-center ring-1 ring-gray-600">
                    <p id="aiFeedback" class="text-sm color-gold">AI Asistan: BaÅŸlatÄ±lÄ±yor...</p>
                </div>
            </div>
            
            <div id="resultSummary" class="hidden my-6 p-4 rounded-lg bg-gray-800 ring-1 ring-gray-700">
                <h3 class="text-xl font-bold color-gold mb-2">âœ… Ã–lÃ§Ã¼m TamamlandÄ±!</h3>
                <p class="text-sm text-gray-400">KesinleÅŸmiÅŸ YÃ¼kseklik:</p>
                <p id="finalHeightText" class="text-4xl font-extrabold text-white mb-4">0.00 m</p>
                
                <button id="geminiInsightButton" class="w-full bg-green-600 text-white p-3 rounded-lg font-bold text-md hover:bg-green-700 transition-all duration-200 shadow-lg active:scale-95 flex items-center justify-center">
                    <span class="mr-2">âœ¨</span> YÃ¼kseklik Analizi Al
                </button>
                
                <div id="aiInsightOutput" class="mt-4 text-left text-sm text-gray-300 space-y-2">
                    </div>
            </div>

            <button id="resetButton" class="w-full bg-red-600 text-white p-3 rounded-lg font-bold text-md hover:bg-red-700 transition-all duration-200 shadow-lg mt-6 active:scale-95">
                SÄ±fÄ±rla ve Geri DÃ¶n
            </button>
        </div>
    </div>

    <script>
        // --- GEMINI API SABÄ°TLERÄ° VE YARDIMCI FONKSÄ°YONLAR ---
        const apiKey = ""; // API key is left empty; Canvas will provide it at runtime.
        const modelName = "gemini-2.5-flash-preview-09-2025";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;

        async function fetchWithBackoff(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status !== 429) { 
                        if (!response.ok) {
                             throw new Error(`API call failed with status ${response.status}`);
                        }
                        return response;
                    }
                    console.warn(`Rate limit (429) encountered. Retrying in ${2 ** i}s...`);
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    console.error(`Fetch error: ${error.message}. Retrying...`);
                }
                await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
            }
            throw new Error("Maximum retry attempts reached.");
        }

        async function fetchGeminiInsight(height) {
            const insightOutput = document.getElementById('aiInsightOutput');
            const button = document.getElementById('geminiInsightButton');
            
            button.disabled = true;
            button.innerHTML = '<span class="mr-2">ğŸ”„</span> Analiz YÃ¼kleniyor...';
            insightOutput.innerHTML = '<p class="text-center text-gray-500">Analiz oluÅŸturuluyor, lÃ¼tfen bekleyin...</p>';

            const userQuery = `${height.toFixed(2)} metre yÃ¼ksekliÄŸindeki bir nesnenin (bina, aÄŸaÃ§ vb.) yÃ¼ksekliÄŸini karÅŸÄ±laÅŸtÄ±rÄ±n. Bu yÃ¼ksekliÄŸin kaÃ§ katlÄ± bir binaya denk geldiÄŸini ve dÃ¼nyadaki bilinen popÃ¼ler yapÄ±larla (Ã¶rneÄŸin, Eyfel Kulesi) karÅŸÄ±laÅŸtÄ±rmasÄ±nÄ± yapÄ±n. AyrÄ±ca bu yÃ¼ksekliÄŸi Ã¶lÃ§mek iÃ§in kullanÄ±lan trigonometri (yÃ¼kseklik aÃ§Ä±sÄ±) hakkÄ±nda kÄ±sa bir bilgi verin. YanÄ±tÄ±nÄ±zÄ± TÃ¼rkÃ§e olarak verin.`;
            
            const systemPrompt = "Sen, Ã¶lÃ§Ã¼m sonuÃ§larÄ±nÄ± analize eden, bilgili ve eÄŸlenceli bir AI AsistanÄ±sÄ±n. Ã–lÃ§Ã¼len yÃ¼ksekliÄŸi (Ã¶rneÄŸin 45m) kullanarak, 3-4 cÃ¼mlelik, karÅŸÄ±laÅŸtÄ±rmalÄ± ve ilgi Ã§ekici bir analiz sun. Bu analizi Google Search sonuÃ§larÄ±nÄ± temel alarak oluÅŸtur.";
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;
                    
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }

                    // Analiz sonucunu gÃ¶ster
                    let outputHTML = `<p class="font-medium color-gold mb-2">Gemini Analizi:</p>`;
                    outputHTML += `<p>${text.replace(/\n/g, '<br>')}</p>`;

                    if (sources.length > 0) {
                        outputHTML += `<p class="mt-3 text-xs text-gray-500">Kaynaklar:`;
                        sources.slice(0, 3).forEach((source, index) => {
                            outputHTML += `<br><a href="${source.uri}" target="_blank" class="hover:underline">${index + 1}. ${source.title}</a>`;
                        });
                        outputHTML += `</p>`;
                    }

                    insightOutput.innerHTML = outputHTML;
                    button.classList.add('bg-gray-500', 'hover:bg-gray-500');
                    button.classList.remove('bg-green-600', 'hover:bg-green-700');
                    button.innerHTML = '<span class="mr-2">âœ…</span> Analiz TamamlandÄ±';

                } else {
                    insightOutput.innerHTML = '<p class="text-red-400">Analiz alÄ±namadÄ±. LÃ¼tfen daha sonra tekrar deneyin.</p>';
                }
            } catch (error) {
                console.error("Gemini API Error:", error);
                insightOutput.innerHTML = '<p class="text-red-400">API baÄŸlantÄ± hatasÄ± oluÅŸtu. Konsolu kontrol edin.</p>';
            } finally {
                button.disabled = false;
                if (!button.classList.contains('bg-gray-500')) {
                    button.classList.add('bg-green-600', 'hover:bg-green-700');
                    button.innerHTML = '<span class="mr-2">âœ¨</span> YÃ¼kseklik Analizi Al';
                }
            }
        }

        // --- UYGULAMA MANTIÄI VE SENSÃ–R Ä°ÅLEMLERÄ° ---
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elementlerini SeÃ§me ---
            const setupScreen = document.getElementById('setup-screen');
            const measurementScreen = document.getElementById('measurement-screen');
            const liveDisplayArea = document.getElementById('liveDisplayArea');
            const resultSummary = document.getElementById('resultSummary');
            
            const distanceInput = document.getElementById('distance');
            const distanceUnit = document.getElementById('distanceUnit'); // YENÄ°
            const userHeightInput = document.getElementById('userHeight');
            const startButton = document.getElementById('startButton');
            const permissionStatus = document.getElementById('permission-status');
            
            const heightDisplay = document.getElementById('heightDisplay');
            const angleDisplay = document.getElementById('angleDisplay');
            const stabilityDisplay = document.getElementById('stabilityDisplay');
            const stabilityBar = document.getElementById('stabilityBar');
            const aiFeedback = document.getElementById('aiFeedback');
            const resetButton = document.getElementById('resetButton');
            const crosshairH = document.getElementById('crosshair-h');
            
            const finalHeightText = document.getElementById('finalHeightText');
            const geminiInsightButton = document.getElementById('geminiInsightButton');
            const aiInsightOutput = document.getElementById('aiInsightOutput');

            // Sekme elementleri
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabPanels = document.querySelectorAll('.tab-panel');

            // --- Uygulama DeÄŸiÅŸkenleri ---
            let distance = 0;       
            let userHeight = 0;     
            let angleHistory = [];  
            let finalMeasuredHeight = 0;
            const historySize = 20; 
            const NEGATIVE_ANGLE_THRESHOLD = -3; 
            const STABILITY_THRESHOLD = 95; 
            let measurementCompleted = false;

            // --- Birim DÃ¶nÃ¼ÅŸÃ¼m Fonksiyonu ---
            /**
             * Girilen uzaklÄ±k deÄŸerini ve birimini alÄ±p, her zaman metre cinsinden dÃ¶ndÃ¼rÃ¼r.
             */
            function convertDistanceToMeters(value, unit) {
                value = parseFloat(value);
                if (isNaN(value) || value <= 0) return 0;
                
                if (unit === 'mm') {
                    return value / 1000; // mm -> m
                }
                // VarsayÄ±lan: metre
                return value; 
            }

            // --- Sekme YÃ¶netimi ---
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active', 'text-black'));
                    button.classList.add('active', 'text-black');
                    button.classList.remove('text-gray-400');
                    tabButtons.forEach(btn => {
                        if (!btn.classList.contains('active')) {
                            btn.classList.add('text-gray-400');
                        }
                    });
                    tabPanels.forEach(panel => panel.classList.add('hidden'));
                    document.getElementById(button.getAttribute('data-tab')).classList.remove('hidden');
                });
            });

            // --- Trigonometri ve YardÄ±mcÄ± Fonksiyonlar ---
            function toRadians(degrees) {
                return degrees * (Math.PI / 180);
            }
            function tan(degrees) {
                return Math.tan(toRadians(degrees));
            }

            // --- AI PROTOTÄ°P FONKSÄ°YONLARI ---
            function stabilizeData(newAngle) {
                angleHistory.push(newAngle);
                if (angleHistory.length > historySize) {
                    angleHistory.shift(); 
                }
                const sum = angleHistory.reduce((a, b) => a + b, 0);
                const stableAngle = sum / angleHistory.length;
                if (angleHistory.length < 2) {
                    return { stableAngle, stabilityPercent: 0 };
                }
                const mean = stableAngle;
                const variance = angleHistory.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / angleHistory.length;
                const stdDev = Math.sqrt(variance);
                let stabilityPercent = 100 * (1 - Math.min(stdDev / 3, 1)); 
                stabilityPercent = Math.max(0, Math.min(100, stabilityPercent)); 
                return { stableAngle, stabilityPercent };
            }

            function getAIFeedback(angle, stability) {
                if (angleHistory.length < historySize) return "Kalibrasyon yapÄ±lÄ±yor... LÃ¼tfen sabit tutun.";
                if (stability < 75) return "Eliniz titriyor. CihazÄ± sabit tutmaya Ã§alÄ±ÅŸÄ±n.";
                if (angle < 5) return "Daha yukarÄ± niÅŸan alÄ±n.";
                if (angle > 85) return "Cihaz Ã§ok dik, hedefi kontrol edin.";
                if (stability > 95) return "Ã–lÃ§Ã¼m stabil. SonuÃ§ hazÄ±r!";
                return "Hedefin tepesine niÅŸan alÄ±nÄ±yor...";
            }

            // --- ANA UYGULAMA MANTIÄI ---
            function handleOrientation(event) {
                if(measurementCompleted) return;

                let rawAngle = event.beta; 
                
                if (rawAngle === null || rawAngle === undefined || rawAngle < NEGATIVE_ANGLE_THRESHOLD) {
                    stopCalculation("Cihaz aÅŸaÄŸÄ± bakÄ±yor veya sensÃ¶r hatasÄ± var!");
                    return;
                }

                let positiveAngle = Math.max(0, rawAngle); 
                positiveAngle = Math.min(90, positiveAngle); 
                
                const { stableAngle, stabilityPercent } = stabilizeData(positiveAngle);
                
                const objectHeightAboveDevice = tan(stableAngle) * distance;
                const totalHeight = objectHeightAboveDevice + userHeight;
                const feedback = getAIFeedback(stableAngle, stabilityPercent);

                updateLiveUI(stableAngle, totalHeight, stabilityPercent, feedback);

                // Ã–lÃ§Ã¼m KararlÄ±lÄ±ÄŸa UlaÅŸtÄ±ysa
                if (stabilityPercent >= STABILITY_THRESHOLD && angleHistory.length === historySize) {
                    finalMeasuredHeight = totalHeight;
                    completeMeasurement(finalMeasuredHeight);
                }
            }

            function completeMeasurement(finalHeight) {
                measurementCompleted = true;
                stopListening(); 

                // ArayÃ¼z geÃ§iÅŸi
                liveDisplayArea.classList.add('hidden');
                resultSummary.classList.remove('hidden');
                finalHeightText.textContent = `${finalHeight.toFixed(2)} m`;
                
                // Gemini Analizi Butonu HazÄ±rlÄ±ÄŸÄ±
                geminiInsightButton.onclick = () => fetchGeminiInsight(finalHeight);
                geminiInsightButton.classList.remove('bg-gray-500', 'hover:bg-gray-500');
                geminiInsightButton.classList.add('bg-green-600', 'hover:bg-green-700');
                geminiInsightButton.innerHTML = '<span class="mr-2">âœ¨</span> YÃ¼kseklik Analizi Al';
                aiInsightOutput.innerHTML = '<p class="text-sm text-gray-500">Analiz almak iÃ§in yukarÄ±daki butona tÄ±klayÄ±n.</p>';

                document.getElementById('liveMeasurementHeader').textContent = "Ã–lÃ§Ã¼m BaÅŸarÄ±yla TamamlandÄ±.";
            }
            
            function stopCalculation(aiMessage) {
                if(!measurementCompleted) {
                    heightDisplay.textContent = "--- m";
                    angleDisplay.textContent = "---Â°";
                    stabilityDisplay.textContent = "0%";
                    stabilityBar.style.width = "0%";
                    aiFeedback.textContent = `AI: ${aiMessage}`;
                    angleHistory = []; 
                    crosshairH.style.transform = `translateX(-50%) translateY(-1px)`;
                }
            }
            
            function updateLiveUI(angle, height, stability, feedback) {
                if(measurementCompleted) return;

                const yShift = -(angle / 90) * 40; 
                crosshairH.style.transform = `translateX(-50%) translateY(calc(-1px + ${yShift}px))`;

                if (angleHistory.length === historySize) {
                    heightDisplay.textContent = `${height.toFixed(2)} m`;
                    angleDisplay.textContent = `${angle.toFixed(1)}Â°`;
                    stabilityDisplay.textContent = `${stability.toFixed(0)}%`;
                    stabilityBar.style.width = `${stability.toFixed(0)}%`;
                } else {
                    let calibratingText = ".".repeat(Math.floor(angleHistory.length / (historySize / 4)) + 1);
                    heightDisplay.textContent = calibratingText;
                    angleDisplay.textContent = '...Â°';
                    stabilityDisplay.textContent = '...%';
                    stabilityBar.style.width = '0%';
                }
                aiFeedback.textContent = `AI: ${feedback}`;
            }
            
            function startListening() {
                window.addEventListener('deviceorientation', handleOrientation);
            }

            function stopListening() {
                window.removeEventListener('deviceorientation', handleOrientation);
            }
            
            function resetAppState() {
                stopListening();
                measurementCompleted = false;
                angleHistory = []; 
                finalMeasuredHeight = 0;

                // ArayÃ¼zÃ¼ BaÅŸlangÄ±Ã§ Durumuna Getir
                setupScreen.classList.remove('hidden');
                measurementScreen.classList.add('hidden');
                liveDisplayArea.classList.remove('hidden');
                resultSummary.classList.add('hidden');
                permissionStatus.textContent = ""; 
                document.getElementById('liveMeasurementHeader').textContent = "Cismin tepesine niÅŸan alÄ±n";

                // CanlÄ± GÃ¶stergeleri Temizle
                stopCalculation("Ã–lÃ§Ã¼m durduruldu."); 
            }

            // --- OLAY DÄ°NLEYÄ°CÄ°LERÄ° ---
            startButton.addEventListener('click', () => {
                // YENÄ°: Birim dÃ¶nÃ¼ÅŸÃ¼mÃ¼ burada yapÄ±lÄ±yor
                const rawDistance = distanceInput.value;
                const unit = distanceUnit.value;
                distance = convertDistanceToMeters(rawDistance, unit); 
                
                userHeight = parseFloat(userHeightInput.value);

                if (distance <= 0) {
                    permissionStatus.textContent = "LÃ¼tfen geÃ§erli bir uzaklÄ±k girin.";
                    return;
                }
                if (isNaN(userHeight) || userHeight < 0) { 
                    permissionStatus.textContent = "LÃ¼tfen geÃ§erli bir cihaz yÃ¼ksekliÄŸi girin.";
                    return;
                }

                permissionStatus.textContent = "SensÃ¶r izni isteniyor...";

                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission()
                        .then(permissionState => {
                            if (permissionState === 'granted') {
                                permissionStatus.textContent = "Ä°zin verildi. BaÅŸlatÄ±lÄ±yor...";
                                startListening();
                                setupScreen.classList.add('hidden');
                                measurementScreen.classList.remove('hidden');
                            } else {
                                permissionStatus.textContent = "SensÃ¶r izni reddedildi. Bu uygulama izin olmadan Ã§alÄ±ÅŸamaz.";
                            }
                        })
                        .catch((error) => {
                            console.error(error);
                            permissionStatus.textContent = "SensÃ¶r izni alÄ±nÄ±rken bir hata oluÅŸtu.";
                        });
                } else {
                    permissionStatus.textContent = "BaÅŸlatÄ±lÄ±yor...";
                    startListening();
                    setupScreen.classList.add('hidden');
                    measurementScreen.classList.remove('hidden');
                }
            });

            resetButton.addEventListener('click', resetAppState);
        });
    </script>
</body>
</html>
