<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrigAI - YÃ¼kseklik Ã–lÃ§er</title>
    <!-- Tailwind CSS CDN'i -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* Projeye Ã¶zel stiller */
        body { 
            font-family: 'Inter', sans-serif; 
            /* Dokunma gecikmesini engelle (mobil iÃ§in) */
            touch-action: manipulation;
        }
        
        /* NiÅŸangah (Crosshair) Stili */
        .crosshair {
            position: relative;
            width: 150px;
            height: 150px;
            /* Hedef Ã§erÃ§evesi */
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            margin: 20px auto;
        }
        .crosshair::before, .crosshair::after {
            content: '';
            position: absolute;
            /* Parlak cyan niÅŸangah Ã§izgileri */
            background: rgba(0, 255, 255, 0.7);
            box-shadow: 0 0 8px rgba(0, 255, 255, 1);
        }
        .crosshair::before { /* Yatay Ã§izgi */
            left: 50%;
            top: calc(50% - 1px);
            width: 50px;
            height: 2px;
            transform: translateX(-50%);
        }
        .crosshair::after { /* Dikey Ã§izgi */
            top: 50%;
            left: calc(50% - 1px);
            height: 50px;
            width: 2px;
            transform: translateY(-50%);
        }

        /* Number input'lardaki oklarÄ± gizle */
        input[type="number"] {
            -moz-appearance: textfield;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[typeK="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen flex items-center justify-center p-4">

    <!-- Ana Uygulama Konteyneri -->
    <div id="app-container" class="w-full max-w-md mx-auto">

        <!-- EKRAN 1: KURULUM (VarsayÄ±lan olarak gÃ¶rÃ¼nÃ¼r) -->
        <div id="setup-screen" class="bg-gray-800 p-6 md:p-8 rounded-2xl shadow-2xl transition-all duration-300">
            <!-- BaÅŸlÄ±k -->
            <h1 class="text-3xl font-bold text-center text-white mb-2">ğŸš€ TrigAI</h1>
            <p class="text-center text-blue-300 mb-6">AkÄ±llÄ± YÃ¼kseklik Ã–lÃ§Ã¼m AsistanÄ±</p>
            
            <!-- Talimatlar -->
            <p class="text-sm text-gray-400 mb-4">LÃ¼tfen Ã¶lÃ§Ã¼m yapmak iÃ§in aÅŸaÄŸÄ±daki bilgileri girin:</p>
            
            <!-- GiriÅŸ 1: UzaklÄ±k (d) -->
            <div class="mb-4">
                <label for="distance" class="block text-sm font-medium text-gray-300 mb-1">1. Cisme Yatay UzaklÄ±k (metre)</label>
                <input type="number" id="distance" value="10" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white text-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Ã–rn: 10">
            </div>

            <!-- GiriÅŸ 2: Cihaz YÃ¼ksekliÄŸi (h_user) -->
            <div class="mb-6">
                <label for="userHeight" class="block text-sm font-medium text-gray-300 mb-1">2. Cihaz YÃ¼ksekliÄŸi (metre)</label>
                <input type="number" id="userHeight" value="1.7" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white text-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Ã–rn: 1.7">
                <p class="text-xs text-gray-500 mt-1">Telefonu tuttuÄŸunuz yÃ¼ksekliÄŸi girin (genellikle gÃ¶z hizanÄ±z).</p>
            </div>

            <!-- BaÅŸlatma Butonu -->
            <button id="startButton" class="w-full bg-blue-600 text-white p-4 rounded-lg font-bold text-lg hover:bg-blue-700 transition-all duration-200 shadow-lg active:scale-95">
                Ã–lÃ§Ã¼mÃ¼ BaÅŸlat
            </button>
            <!-- Ä°zin durumu iÃ§in mesaj alanÄ± -->
            <p id="permission-status" class="text-center text-yellow-400 text-sm mt-4 h-5"></p>
        </div>

        <!-- EKRAN 2: Ã–LÃ‡ÃœM (VarsayÄ±lan olarak gizli) -->
        <div id="measurement-screen" class="hidden bg-gray-800 p-6 md:p-8 rounded-2xl shadow-2xl text-center transition-all duration-300">
            
            <!-- NiÅŸangah -->
            <p class="text-sm text-gray-400 mb-2">Cismin tepesine niÅŸan alÄ±n</p>
            <div class="crosshair"></div>

            <!-- SonuÃ§: YÃ¼kseklik -->
            <h2 class="text-gray-400 text-lg font-semibold uppercase tracking-wider">Tahmini YÃ¼kseklik</h2>
            <div id="heightDisplay" class="text-6xl font-extrabold text-white my-2">0.00 m</div>
            
            <!-- CanlÄ± Veri Paneli -->
            <div class="flex justify-around bg-gray-900 rounded-lg p-4 my-4">
                <div>
                    <div class="text-xs text-blue-300 uppercase">EÄŸim AÃ§Ä±sÄ± (Î²)</div>
                    <div id="angleDisplay" class="text-2xl font-bold text-white">0.0Â°</div>
                </div>
                <div>
                    <div class="text-xs text-blue-300 uppercase">KararlÄ±lÄ±k</div>
                    <div id="stabilityDisplay" class="text-2xl font-bold text-white">--%</div>
                </div>
            </div>

            <!-- KararlÄ±lÄ±k Ã‡ubuÄŸu -->
            <div class="w-full bg-gray-700 rounded-full h-2.5 mb-4 overflow-hidden">
                <div id="stabilityBar" class="bg-blue-500 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            
            <!-- AI Geri Bildirim Paneli -->
            <div class="bg-gray-700 p-3 rounded-lg min-h-[50px] flex items-center justify-center">
                <p id="aiFeedback" class="text-sm text-yellow-300">AI Asistan: BaÅŸlatÄ±lÄ±yor...</p>
            </div>

            <!-- SÄ±fÄ±rlama Butonu -->
            <button id="resetButton" class="w-full bg-gray-600 text-white p-3 rounded-lg font-bold text-md hover:bg-gray-500 transition-all duration-200 shadow-lg mt-6 active:scale-95">
                SÄ±fÄ±rla ve Geri DÃ¶n
            </button>
        </div>
    </div>

    <!-- JavaScript Kodu -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elementlerini SeÃ§me ---
            const setupScreen = document.getElementById('setup-screen');
            const measurementScreen = document.getElementById('measurement-screen');
            
            const distanceInput = document.getElementById('distance');
            const userHeightInput = document.getElementById('userHeight');
            const startButton = document.getElementById('startButton');
            const permissionStatus = document.getElementById('permission-status');
            
            const heightDisplay = document.getElementById('heightDisplay');
            const angleDisplay = document.getElementById('angleDisplay');
            const stabilityDisplay = document.getElementById('stabilityDisplay');
            const stabilityBar = document.getElementById('stabilityBar');
            const aiFeedback = document.getElementById('aiFeedback');
            const resetButton = document.getElementById('resetButton');

            // --- Uygulama DeÄŸiÅŸkenleri ---
            let distance = 0;       // KullanÄ±cÄ±nÄ±n girdiÄŸi 'd' deÄŸeri
            let userHeight = 0;     // KullanÄ±cÄ±nÄ±n girdiÄŸi cihaz yÃ¼ksekliÄŸi
            let angleHistory = [];  // AI Filtresi iÃ§in aÃ§Ä± geÃ§miÅŸi
            const historySize = 20; // AI Filtresi iÃ§in son 20 veriyi sakla (daha pÃ¼rÃ¼zsÃ¼z)

            // --- Trigonometri ve YardÄ±mcÄ± Fonksiyonlar ---

            // Dereceyi radyana Ã§evirir
            function toRadians(degrees) {
                return degrees * (Math.PI / 180);
            }

            // Verilen derecenin tanjantÄ±nÄ± hesaplar
            function tan(degrees) {
                return Math.tan(toRadians(degrees));
            }

            // --- AI PROTOTÄ°P FONKSÄ°YONLARI ---

            /**
             * AI Filtresi (Veri Dengeleme): 
             * Gelen ham aÃ§Ä± verisini yumuÅŸatÄ±r ve kararlÄ±lÄ±ÄŸÄ± hesaplar.
             * Basit bir hareketli ortalama (stabil aÃ§Ä±) ve standart sapma (kararlÄ±lÄ±k) kullanÄ±r.
             */
            function stabilizeData(newAngle) {
                // 1. Veri Dengeleme (Hareketli Ortalama)
                angleHistory.push(newAngle);
                if (angleHistory.length > historySize) {
                    angleHistory.shift(); // En eski veriyi listeden Ã§Ä±kar
                }
                
                const sum = angleHistory.reduce((a, b) => a + b, 0);
                const stableAngle = sum / angleHistory.length;

                // 2. KararlÄ±lÄ±k (Stabilite) HesabÄ± (Standart Sapma)
                if (angleHistory.length < 2) {
                    // Yeterli veri yoksa
                    return { stableAngle, stabilityPercent: 0 };
                }
                
                const mean = stableAngle;
                // SapmalarÄ±n karesinin ortalamasÄ± (Varyans)
                const variance = angleHistory.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / angleHistory.length;
                // Standart Sapma
                const stdDev = Math.sqrt(variance);

                // Standart sapmayÄ± 0-100 arasÄ± bir kararlÄ±lÄ±k yÃ¼zdesine Ã§evir
                // Bu formÃ¼l sezgiseldir: 
                // stdDev 0 ise kararlÄ±lÄ±k %100
                // stdDev 3 veya daha fazlaysa kararlÄ±lÄ±k %0
                let stabilityPercent = 100 * (1 - Math.min(stdDev / 3, 1)); 
                stabilityPercent = Math.max(0, Math.min(100, stabilityPercent)); // DeÄŸeri 0-100 arasÄ±nda sÄ±nÄ±rla

                return { stableAngle, stabilityPercent };
            }

            /**
             * AI Durum Tahmini: 
             * KullanÄ±cÄ±ya mevcut duruma gÃ¶re yÃ¶nlendirici geri bildirim verir.
             */
            function getAIFeedback(angle, stability) {
                // Filtre dolana kadar kalibrasyon yapÄ±lÄ±r
                if (angleHistory.length < historySize) {
                    return "Kalibrasyon yapÄ±lÄ±yor... LÃ¼tfen sabit tutun.";
                }
                if (stability < 75) {
                    return "Eliniz titriyor. CihazÄ± sabit tutmaya Ã§alÄ±ÅŸÄ±n.";
                }
                if (angle < 5) {
                    return "Daha yukarÄ± niÅŸan alÄ±n.";
                }
                if (angle > 85) {
                    // 90'a Ã§ok yakÄ±nsa tanjant sonsuza gider
                    return "Cihaz Ã§ok dik, hedefi kontrol edin.";
                }
                if (stability > 95) {
                    return "Ã–lÃ§Ã¼m stabil. Harika!";
                }
                return "Hedefin tepesine niÅŸan alÄ±nÄ±yor...";
            }

            // --- ANA UYGULAMA MANTIÄI ---

            // CihazÄ±n yÃ¶nÃ¼ deÄŸiÅŸtiÄŸinde tetiklenir
            function handleOrientation(event) {
                // 'beta' (pitch), cihazÄ±n Ã¶ne/arkaya eÄŸimidir. 
                // 0 = dÃ¼z (yere paralel), 90 = dik (ekran yukarÄ±)
                let rawAngle = event.beta; 
                
                if (rawAngle === null || rawAngle === undefined) {
                    aiFeedback.textContent = "Hata: SensÃ¶r verisi alÄ±namÄ±yor.";
                    return;
                }

                // Sadece pozitif eÄŸimi (yukarÄ± bakÄ±ÅŸÄ±) dikkate alÄ±yoruz
                if (rawAngle < 0) rawAngle = 0; 
                if (rawAngle > 90) rawAngle = 90; // 90 derece ile sÄ±nÄ±rla
                
                // 1. AI Filtresini ve Stabilizasyonu uygula
                const { stableAngle, stabilityPercent } = stabilizeData(rawAngle);

                // 2. YÃ¼ksekliÄŸi hesapla: h = tan(Î²) Ã— d
                const objectHeightAboveDevice = tan(stableAngle) * distance;
                
                // 3. Toplam yÃ¼ksekliÄŸi hesapla: h_toplam = h + h_kullanÄ±cÄ±
                const totalHeight = objectHeightAboveDevice + userHeight;

                // 4. AI Geri bildirimini al
                const feedback = getAIFeedback(stableAngle, stabilityPercent);

                // 5. ArayÃ¼zÃ¼ GÃ¼ncelle
                updateUI(stableAngle, totalHeight, stabilityPercent, feedback);
            }
            
            // ArayÃ¼zÃ¼ gÃ¼ncelleyen ana fonksiyon
            function updateUI(angle, height, stability, feedback) {
                // Sadece AI filtresi tamamen dolduÄŸunda (kalibrasyon bittiÄŸinde)
                // gerÃ§ek deÄŸerleri gÃ¶ster, yoksa "kalibre oluyor" animasyonu gÃ¶ster.
                if (angleHistory.length === historySize) {
                    heightDisplay.textContent = `${height.toFixed(2)} m`;
                    angleDisplay.textContent = `${angle.toFixed(1)}Â°`;
                    stabilityDisplay.textContent = `${stability.toFixed(0)}%`;
                    // KararlÄ±lÄ±k Ã§ubuÄŸunu gÃ¼ncelle
                    stabilityBar.style.width = `${stability.toFixed(0)}%`;
                } else {
                    // Kalibrasyon sÄ±rasÄ±nda bekleme durumu
                    let calibratingText = ".".repeat(Math.floor(angleHistory.length / (historySize / 4)) + 1);
                    heightDisplay.textContent = calibratingText;
                    angleDisplay.textContent = '...Â°';
                    stabilityDisplay.textContent = '...%';
                    stabilityBar.style.width = '0%';
                }
                aiFeedback.textContent = `AI: ${feedback}`;
            }
            
            // SensÃ¶r dinleyicisini baÅŸlatan fonksiyon
            function startListening() {
                // 'deviceorientation' olayÄ±, ivmeÃ¶lÃ§er ve jiroskop verilerini birleÅŸtirir
                window.addEventListener('deviceorientation', handleOrientation);
            }

            // SensÃ¶r dinleyicisini durduran fonksiyon
            function stopListening() {
                window.removeEventListener('deviceorientation', handleOrientation);
                angleHistory = []; // Filtre geÃ§miÅŸini temizle
            }

            // --- OLAY DÄ°NLEYÄ°CÄ°LERÄ° (EVENT LISTENERS) ---

            // "Ã–lÃ§Ã¼mÃ¼ BaÅŸlat" Butonu
            startButton.addEventListener('click', () => {
                // 1. DeÄŸerleri al ve doÄŸrula
                distance = parseFloat(distanceInput.value);
                userHeight = parseFloat(userHeightInput.value);

                if (isNaN(distance) || distance <= 0) {
                    permissionStatus.textContent = "LÃ¼tfen geÃ§erli bir uzaklÄ±k girin.";
                    return;
                }
                if (isNaN(userHeight) || userHeight <= 0) {
                    permissionStatus.textContent = "LÃ¼tfen geÃ§erli bir cihaz yÃ¼ksekliÄŸi girin.";
                    return;
                }

                permissionStatus.textContent = "SensÃ¶r izni isteniyor...";

                // 2. Cihaz YÃ¶nlendirme Ä°zni (Ã–zellikle iOS 13+ iÃ§in GEREKLÄ°)
                // 'requestPermission' fonksiyonu sadece gÃ¼venli (HTTPS) context'lerde ve
                // bir kullanÄ±cÄ± etkileÅŸimi (tÄ±klama) ile Ã§aÄŸrÄ±labilir.
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    
                    DeviceOrientationEvent.requestPermission()
                        .then(permissionState => {
                            if (permissionState === 'granted') {
                                // Ä°zin verildi
                                permissionStatus.textContent = "Ä°zin verildi. BaÅŸlatÄ±lÄ±yor...";
                                startListening();
                                // EkranlarÄ± deÄŸiÅŸtir
                                setupScreen.classList.add('hidden');
                                measurementScreen.classList.remove('hidden');
                            } else {
                                // Ä°zin reddedildi
                                permissionStatus.textContent = "SensÃ¶r izni reddedildi. Bu uygulama izin olmadan Ã§alÄ±ÅŸamaz.";
                            }
                        })
                        .catch((error) => {
                            console.error(error);
                            permissionStatus.textContent = "SensÃ¶r izni alÄ±nÄ±rken bir hata oluÅŸtu.";
                        });
                } else {
                    // Android ve izin gerektirmeyen diÄŸer cihazlar
                    permissionStatus.textContent = "BaÅŸlatÄ±lÄ±yor...";
                    startListening();
                    setupScreen.classList.add('hidden');
                    measurementScreen.classList.remove('hidden');
                }
            });

            // "SÄ±fÄ±rla" Butonu
            resetButton.addEventListener('click', () => {
                stopListening(); // SensÃ¶rleri durdur
                // EkranlarÄ± eski haline getir
                setupScreen.classList.remove('hidden');
                measurementScreen.classList.add('hidden');
                permissionStatus.textContent = ""; // Durum mesajÄ±nÄ± temizle
            });
        });
    </script>
</body>
</html>
