<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TRIGO AI - CanlÄ± YÃ¼kseklik Ã–lÃ§er</title>
    <!-- Tailwind CSS CDN'i -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter (genel metin) ve Audiowide (logo iÃ§in) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Audiowide&family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* Projeye Ã¶zel stiller */
        body { 
            font-family: 'Inter', sans-serif; 
            touch-action: manipulation;
            overscroll-behavior: none;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Dinamik Renkler iÃ§in CSS DeÄŸiÅŸkenleri */
        :root {
            /* Light Theme (VarsayÄ±lan) */
            --bg-primary: #ffffff;      
            --bg-secondary: #f3f4f6;    
            --bg-tertiary: #e5e7eb;     
            --text-primary: #111827;    
            --text-secondary: #4b5563;  
            --ring-color: #d1d5db;      
            --input-bg: #ffffff;
            --input-border: #d1d5db;
        }

        /* Dark Theme SÄ±nÄ±fÄ± */
        .dark-theme {
            --bg-primary: #111827;      
            --bg-secondary: #1f2937;    
            --bg-tertiary: #374151;     
            --text-primary: #f9fafb;    
            --text-secondary: #9ca3af;  
            --ring-color: #374151;      
            --input-bg: #1f2937;        
            --input-border: #374151;    
        }
        
        /* Tema UygulamasÄ± */
        .app-bg {
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        .app-card {
            background: linear-gradient(to bottom right, var(--bg-secondary), var(--bg-tertiary));
            border: 1px solid var(--ring-color);
            color: var(--text-primary);
        }
        .app-text-secondary {
            color: var(--text-secondary);
        }
        .app-text-primary {
            color: var(--text-primary);
        }
        .app-input {
            background-color: var(--input-bg);
            border-color: var(--input-border);
            color: var(--text-primary);
        }

        /* Logo iÃ§in Ã¶zel font sÄ±nÄ±fÄ± (Audiowide) */
        .font-logo {
            font-family: 'Audiowide', sans-serif;
            letter-spacing: 1.5px;
        }
        
        /* Dinamik AltÄ±n Rengi */
        .color-gold {
            color: rgb(229, 174, 50);
        }
        
        /* NiÅŸangah (Crosshair) Stili - AltÄ±n Rengi */
        .crosshair {
            position: relative;
            width: 150px;
            height: 150px;
            border: 2px dashed var(--ring-color);
            border-radius: 50%;
            margin: 20px auto;
        }
        /* Dikey Ã§izgi (Sabit) */
        .crosshair-line-v {
            position: absolute;
            top: 50%;
            left: calc(50% - 1px);
            height: 50px;
            width: 2px;
            background: rgba(229, 174, 50, 0.7);
            box-shadow: 0 0 8px rgba(229, 174, 50, 1);
            transform: translateY(-50%);
        }
        /* Yatay Ã§izgi (DÄ°NAMÄ°K) */
        .crosshair-line-h {
            position: absolute;
            left: 50%;
            top: 50%; 
            width: 50px;
            height: 2px;
            background: rgba(229, 174, 50, 0.7);
            box-shadow: 0 0 8px rgba(229, 174, 50, 1);
            transform: translateX(-50%) translateY(-1px); 
            transition: transform 0.1s linear; 
        }

        /* Number input'lardaki oklarÄ± gizle */
        input[type="number"] {
            -moz-appearance: textfield;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        /* Aktif sekme stili - AltÄ±n Rengi */
        .tab-btn {
            color: var(--text-secondary);
            transition: all 0.2s;
            background-color: var(--bg-tertiary);
        }
        .tab-btn.active {
            background-color: rgb(229, 174, 50);
            color: black;
        }

        /* Birim ButonlarÄ± Stili */
        .unit-btn {
            background-color: var(--bg-tertiary); 
            color: var(--text-secondary); 
            border: 1px solid var(--ring-color); 
            transition: all 0.1s;
            font-weight: 500;
        }
        .unit-btn:hover:not(.active-unit) {
            background-color: var(--input-border); 
        }
        .active-unit {
            background-color: rgb(229, 174, 50); /* color-gold */
            color: black;
            border-color: rgb(229, 174, 50);
            box-shadow: 0 0 5px rgba(229, 174, 50, 0.5);
        }
        
        /* Tema DeÄŸiÅŸtirme Butonu (Switch) */
        .theme-switch {
            width: 56px;
            height: 30px;
            background: var(--bg-tertiary);
            border-radius: 15px;
            position: relative;
            cursor: pointer;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .theme-switch::after {
            content: 'â˜€ï¸';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 26px;
            height: 26px;
            background: #fef3c7; /* Amber-100 */
            border-radius: 50%;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        .dark-theme .theme-switch::after {
            transform: translateX(26px);
            content: 'ğŸŒ™';
            background: #1f2937; /* Gray-800 */
            box-shadow: 0 0 5px rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="app-bg flex items-center justify-center min-h-screen p-4">

    <!-- Ana Uygulama Konteyneri -->
    <div id="app-container" class="w-full max-w-md mx-auto">

        <!-- EKRAN 1: KURULUM (GeliÅŸmiÅŸ Sekmeli ArayÃ¼z) -->
        <div id="setup-screen" class="app-card p-6 rounded-2xl shadow-2xl transition-all duration-300">
            
            <!-- BaÅŸlÄ±k ve Tema DeÄŸiÅŸtirme -->
            <div class="flex justify-between items-center mb-6">
                <!-- LOGO (Audiowide Fontu ile) -->
                <div>
                    <h1 class="font-logo text-4xl font-bold color-gold mb-0">TRIGO AI</h1>
                    <p class="text-sm app-text-secondary">AkÄ±llÄ± YÃ¼kseklik AsistanÄ±</p>
                </div>
                <!-- YENÄ°: Tema AnahtarÄ± -->
                <div class="flex items-center space-x-2">
                    <span class="app-text-secondary text-sm font-medium hidden sm:inline">Koyu Tema</span>
                    <div id="themeToggle" class="theme-switch"></div>
                </div>
            </div>
            
            <!-- Sekme ButonlarÄ± -->
            <div class="flex mb-4 rounded-lg p-1 text-sm" style="background-color: var(--bg-tertiary);">
                <button class="tab-btn flex-1 p-2 rounded-md font-semibold transition-all active" data-tab="tab-input">
                    GiriÅŸ
                </button>
                <button class="tab-btn flex-1 p-2 rounded-md font-semibold transition-all" data-tab="tab-simple">
                    Basit AnlatÄ±m
                </button>
                <button class="tab-btn flex-1 p-2 rounded-md font-semibold transition-all" data-tab="tab-purpose">
                    Proje AmacÄ±
                </button>
                <button class="tab-btn flex-1 p-2 rounded-md font-semibold transition-all" data-tab="tab-how">
                    NasÄ±l Ã‡alÄ±ÅŸÄ±r?
                </button>
            </div>

            <!-- Sekme Ä°Ã§erikleri -->
            <div id="tab-content">
                <!-- 1. GÄ°RÄ°Å SEKMESÄ° (VarsayÄ±lan) -->
                <div id="tab-input" class="tab-panel">
                    <p class="text-sm app-text-secondary mb-4">LÃ¼tfen Ã¶lÃ§Ã¼m yapmak iÃ§in aÅŸaÄŸÄ±daki bilgileri girin:</p>
                    
                    <div class="mb-4">
                        <label for="distance" class="block text-sm font-medium app-text-secondary mb-1">1. Cisme Yatay UzaklÄ±k</label>
                        <input type="number" id="distance" value="10" class="app-input w-full p-3 border rounded-lg text-lg focus:ring-2 focus:ring-[rgb(229,174,50)] focus:outline-none" placeholder="Ã–rn: 10">
                        
                        <!-- UzaklÄ±k Birimi SeÃ§im ButonlarÄ± -->
                        <div class="unit-selector-group flex space-x-2 mt-2" data-target="distance">
                            <button data-unit="m" class="unit-btn flex-1 p-1 rounded-lg text-sm active-unit">metre (m)</button>
                            <button data-unit="cm" class="unit-btn flex-1 p-1 rounded-lg text-sm">santimetre (cm)</button>
                            <button data-unit="mm" class="unit-btn flex-1 p-1 rounded-lg text-sm">milimetre (mm)</button>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label for="userHeight" class="block text-sm font-medium app-text-secondary mb-1">2. Cihaz YÃ¼ksekliÄŸi</label>
                        <input type="number" id="userHeight" value="1.7" class="app-input w-full p-3 border rounded-lg text-lg focus:ring-2 focus:ring-[rgb(229,174,50)] focus:outline-none" placeholder="Ã–rn: 1.7">
                        
                        <!-- Cihaz YÃ¼ksekliÄŸi Birimi SeÃ§im ButonlarÄ± -->
                        <div class="unit-selector-group flex space-x-2 mt-2" data-target="userHeight">
                            <button data-unit="m" class="unit-btn flex-1 p-1 rounded-lg text-sm active-unit">metre (m)</button>
                            <button data-unit="cm" class="unit-btn flex-1 p-1 rounded-lg text-sm">santimetre (cm)</button>
                            <button data-unit="mm" class="unit-btn flex-1 p-1 rounded-lg text-sm">milimetre (mm)</button>
                        </div>

                        <p class="text-xs app-text-secondary mt-1 opacity-70">Telefonu tuttuÄŸunuz yÃ¼kseklik (gÃ¶z hizanÄ±z).</p>
                    </div>

                    <!-- BaÅŸlatma Butonu - AltÄ±n Rengi -->
                    <button id="startButton" class="w-full bg-[rgb(229,174,50)] text-black p-4 rounded-lg font-bold text-lg hover:bg-[rgb(209,154,30)] transition-all duration-200 shadow-lg active:scale-95">
                        Ã–lÃ§Ã¼mÃ¼ BaÅŸlat
                    </button>
                    <!-- Ä°zin durumu iÃ§in mesaj alanÄ± - AltÄ±n Rengi -->
                    <p id="permission-status" class="text-center color-gold text-sm mt-4 h-5"></p>
                </div>

                <!-- 2. BASÄ°T ANLATIM SEKMESÄ° -->
                <div id="tab-simple" class="tab-panel hidden app-text-secondary text-sm space-y-3">
                    <h3 class="font-semibold text-lg app-text-primary mb-2">Bu Sistem Ne Ä°ÅŸe YarÄ±yor? </h3>
                    <p>Diyelim karÅŸÄ±daki binanÄ±n boyunu merak ettiniz. Bu sistem, telefonununuzu <b>akÄ±llÄ± bir metreye </b> dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r.</p>
                    <p>Olay basit:</p>
                    <ul class="list-disc list-outside space-y-2 pl-5">
                        <li>
                            <strong class="app-text-primary">1. AdÄ±m UzaklÄ±ÄŸÄ± SÃ¶yleme :</strong> Siz programa "Ben binadan 15 metre uzaktayÄ±m" diyorsunsunuz (mm, cm, m olarak girebilirsiniz).
                        </li>
                        <li>
                            <strong class="app-text-primary">2. Hedef AÃ§Ä±sÄ± Alma :</strong> Telefonunuzu binanÄ±n <strong class="color-gold">tepesine</strong> doÄŸrultuyorsunuz.
                        </li>
                        <li>
                            <strong class="app-text-primary">3. Ã–lÃ§Ã¼m Sonucu :</strong> Program, telefonu ne kadar <strong class="color-gold">yukarÄ±</strong> kaldÄ±rdÄ±ÄŸÄ±nÄ±zÄ± anlÄ±yor, basit bir matematik yapÄ±yor ve "O BÄ°NA 25 METREYMÄ°Å" diyor.
                        </li>
                    </ul>
                    <p class="font-medium app-text-secondary mt-3 opacity-80"> AI (Yapay ZekÃ¢) ise senin <strong class="app-text-primary">el titremeninizi</strong> yok sayÄ±p Ã¶lÃ§Ã¼mÃ¼ tertemiz yapÄ±yor.</p>
                </div>

                <!-- 3. PROJE AMACI SEKMESÄ° -->
                <div id="tab-purpose" class="tab-panel hidden app-text-secondary text-sm space-y-3">
                    <h3 class="font-semibold text-lg app-text-primary mb-2">Trigonometri GÃ¶z HizanÄ±zda</h3>
                    <p>TRIGO AI, bir binanÄ±n, bir aÄŸacÄ±n veya herhangi bir yÃ¼ksek nesnenin boyunu Ã¶lÃ§mek iÃ§in telefonunuzun sensÃ¶rlerini ve temel trigonometriyi kullanÄ±r.</p>
                    <p>AmacÄ±mÄ±z, matematiÄŸi kaÄŸÄ±t Ã¼zerindeki bir formÃ¼l olmaktan Ã§Ä±karÄ±p, onu herkesin kullanabileceÄŸi, AI (Yapay ZekÃ¢) destekli pratik bir Ã¶lÃ§Ã¼m aracÄ±na dÃ¶nÃ¼ÅŸtÃ¼rmektir.</p>
                    <p class="font-medium color-gold"> Mm, cm ve m birimlerinde hassas giriÅŸler yapabilir, ister koyu ister aÃ§Ä±k temada Ã§alÄ±ÅŸabilirsiniz.</p>
                </div>
                
                <!-- 4. NASIL Ã‡ALIÅIR? SEKMESÄ° -->
                <div id="tab-how" class="tab-panel hidden app-text-secondary text-sm space-y-3">
                    <h3 class="font-semibold text-lg app-text-primary mb-2">HayatÄ± KolaylaÅŸtÄ±ran FormÃ¼l!</h3>
                    <p>Sizden tek istediÄŸimiz, Ã¶lÃ§tÃ¼ÄŸÃ¼nÃ¼z nesneye olan yatay uzaklÄ±ÄŸÄ±nÄ±zÄ± (yani "d" yi ) bilmeniz. Girilen tÃ¼m birimler, hesaplama Ã¶ncesinde metreye Ã§evrilir.</p>
                    <p>Siz hedefin tepesine niÅŸan aldÄ±ÄŸÄ±nÄ±zda, telefonunuzun eÄŸim sensÃ¶rÃ¼ (jiroskop) Î² (beta) aÃ§Ä±sÄ±nÄ± Ã¶lÃ§er.</p>
                    <p>Uygulama, bu iki bilgiyi kullanarak anÄ±nda o meÅŸhur formÃ¼lÃ¼ uygular:</p>
                    <div class="text-center p-3 rounded-lg my-2" style="background-color: var(--bg-tertiary);">
                        <code class="text-base color-gold">YÃ¼kseklik = tan(Î²) Ã— UzaklÄ±k (d) + Cihaz YÃ¼ksekliÄŸi</code>
                    </div>
                    <p>AI'nÄ±n rolÃ¼ ise, el titremesi gibi sensÃ¶r hatalarÄ±nÄ± filtreleyerek Î² aÃ§Ä±sÄ±nÄ± stabilize etmek ve size en doÄŸru sonucu sunmaktÄ±r.</p>
                </div>
            </div>
        </div>

        <!-- EKRAN 2: Ã–LÃ‡ÃœM (CanlÄ± ve SÃ¼rekli GÃ¶sterim) -->
        <div id="measurement-screen" class="hidden app-card p-6 md:p-8 rounded-2xl shadow-2xl text-center transition-all duration-300">
            
            <!-- BAÅLANGIÃ‡ VERÄ°LERÄ° PANELI (Context) -->
            <div id="inputContext" class="p-3 rounded-xl mb-4 text-left shadow-inner ring-1" style="background-color: var(--bg-primary); border-color: var(--ring-color);">
                <div class="flex justify-between text-xs font-semibold uppercase tracking-wider">
                    <div class="flex-1 border-r pr-3" style="border-color: var(--ring-color);">
                        <span class="color-gold">UZAKLIK (D):</span>
                        <div id="contextDistance" class="text-xl font-bold app-text-primary">---</div>
                    </div>
                    <div class="flex-1 pl-3">
                        <span class="color-gold">CÄ°HAZ HÄ°ZASI (H):</span>
                        <div id="contextUserHeight" class="text-xl font-bold app-text-primary">---</div>
                    </div>
                </div>
            </div>
            
            <p id="liveMeasurementHeader" class="text-sm app-text-secondary mb-2">Hedefe niÅŸan alÄ±n ve sonucu anlÄ±k olarak izleyin.</p>
            
            <!-- NiÅŸangah ve CanlÄ± YÃ¼kseklik AlanÄ± -->
            <div id="liveDisplayArea">
                <div class="crosshair">
                    <div id="crosshair-h" class="crosshair-line-h"></div>
                    <div class="crosshair-line-v"></div>
                </div>

                <h2 class="app-text-secondary text-lg font-semibold uppercase tracking-wider">Tahmini YÃ¼kseklik</h2>
                <div id="heightDisplay" class="text-6xl font-extrabold app-text-primary my-2">0.00 m</div>
                
                <!-- CanlÄ± Veri Paneli -->
                <div class="flex justify-around rounded-lg p-4 my-4 ring-1" style="background-color: var(--bg-primary); border-color: var(--ring-color);">
                    <div>
                        <div class="text-xs color-gold uppercase">EÄŸim AÃ§Ä±sÄ± (Î²)</div>
                        <div id="angleDisplay" class="text-2xl font-bold app-text-primary">0.0Â°</div>
                    </div>
                    <div>
                        <div class="text-xs color-gold uppercase">KararlÄ±lÄ±k</div>
                        <div id="stabilityDisplay" class="text-2xl font-bold app-text-primary">--%</div>
                    </div>
                </div>

                <!-- KararlÄ±lÄ±k Ã‡ubuÄŸu -->
                <div class="w-full rounded-full h-2.5 mb-4 overflow-hidden" style="background-color: var(--bg-tertiary);">
                    <div id="stabilityBar" class="bg-[rgb(229,174,50)] h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                
                <!-- AI Filtre Geri Bildirim Paneli -->
                <div class="p-3 rounded-lg min-h-[50px] flex items-center justify-center ring-1" style="background-color: var(--bg-tertiary); border-color: var(--ring-color);">
                    <p id="aiFeedback" class="text-sm color-gold">AI Asistan: BaÅŸlatÄ±lÄ±yor...</p>
                </div>
            </div>
            
            <!-- SÄ±fÄ±rlama Butonu -->
            <button id="resetButton" class="w-full bg-red-600 text-white p-3 rounded-lg font-bold text-md hover:bg-red-700 transition-all duration-200 shadow-lg mt-6 active:scale-95">
                Ã–lÃ§Ã¼mÃ¼ Durdur ve Geri DÃ¶n
            </button>
        </div>
    </div>

    <!-- JavaScript Kodu (AÃ§Ä± HesaplamalarÄ±, Birimler ve Tema YÃ¶netimi) -->
    <script>
        // --- UYGULAMA MANTIÄI VE SENSÃ–R Ä°ÅLEMLERÄ° ---
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elementlerini SeÃ§me ---
            const setupScreen = document.getElementById('setup-screen');
            const measurementScreen = document.getElementById('measurement-screen');
            
            const distanceInput = document.getElementById('distance');
            const userHeightInput = document.getElementById('userHeight');
            const startButton = document.getElementById('startButton');
            const permissionStatus = document.getElementById('permission-status');
            
            const heightDisplay = document.getElementById('heightDisplay');
            const angleDisplay = document.getElementById('angleDisplay');
            const stabilityDisplay = document.getElementById('stabilityDisplay');
            const stabilityBar = document.getElementById('stabilityBar');
            const aiFeedback = document.getElementById('aiFeedback');
            const resetButton = document.getElementById('resetButton');
            const crosshairH = document.getElementById('crosshair-h');
            
            const themeToggle = document.getElementById('themeToggle'); 
            const contextDistance = document.getElementById('contextDistance');
            const contextUserHeight = document.getElementById('contextUserHeight');

            // Sekme elementleri ve birim butonlarÄ±
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabPanels = document.querySelectorAll('.tab-panel');
            const unitSelectorGroups = document.querySelectorAll('.unit-selector-group');

            // --- Uygulama DeÄŸiÅŸkenleri ---
            // Hesaplama iÃ§in metre cinsinden deÄŸerler
            let distanceMeters = 0;       
            let userHeightMeters = 0;     
            
            // GÃ¶rÃ¼ntÃ¼leme iÃ§in kullanÄ±cÄ± girdileri
            let inputDistanceValue = 0;
            let inputDistanceUnit = 'm';
            let inputUserHeightValue = 0;
            let inputUserHeightUnit = 'm';

            let angleHistory = [];  
            const historySize = 20; // Filtre iÃ§in gereken veri noktasÄ± sayÄ±sÄ±
            const NEGATIVE_ANGLE_THRESHOLD = -3; 
            
            // --- TEMA YÃ–NETÄ°MÄ° ---
            const currentTheme = localStorage.getItem('theme') || 'light';
            
            function applyTheme(theme) {
                if (theme === 'dark') {
                    document.body.classList.add('dark-theme');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.body.classList.remove('dark-theme');
                    localStorage.setItem('theme', 'light');
                }
            }

            // Sayfa yÃ¼klendiÄŸinde temayÄ± uygula
            applyTheme(currentTheme);

            themeToggle.addEventListener('click', () => {
                const newTheme = document.body.classList.contains('dark-theme') ? 'light' : 'dark';
                applyTheme(newTheme);
            });

            // --- Birim DÃ¶nÃ¼ÅŸÃ¼m Fonksiyonu ---
            function convertValueToMeters(value, unit) {
                value = parseFloat(value);
                if (isNaN(value) || value <= 0) return 0;
                
                if (unit === 'mm') {
                    return value / 1000; 
                }
                if (unit === 'cm') {
                    return value / 100; 
                }
                return value; 
            }
            
            function formatValue(value, unit) {
                if (unit === 'mm' || unit === 'cm') {
                    // SayÄ±nÄ±n virgÃ¼lden sonraki kÄ±smÄ±nÄ± temizle ama ondalÄ±k nokta varsa tut
                    return (value % 1 === 0) ? value.toFixed(0) : value.toString();
                }
                return value.toFixed(2);
            }

            // --- Sekme YÃ¶netimi ---
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    tabPanels.forEach(panel => panel.classList.add('hidden'));
                    document.getElementById(button.getAttribute('data-tab')).classList.remove('hidden');
                });
            });

            // --- Birim Butonu YÃ¶netimi ---
            unitSelectorGroups.forEach(group => {
                group.addEventListener('click', (e) => {
                    const clickedButton = e.target.closest('.unit-btn');
                    if (!clickedButton) return;

                    group.querySelectorAll('.unit-btn').forEach(btn => {
                        btn.classList.remove('active-unit');
                    });

                    clickedButton.classList.add('active-unit');
                });
            });


            // --- Trigonometri ve YardÄ±mcÄ± Fonksiyonlar ---
            function toRadians(degrees) {
                return degrees * (Math.PI / 180);
            }
            function tan(degrees) {
                return Math.tan(toRadians(degrees));
            }

            // --- AI PROTOTÄ°P FONKSÄ°YONLARI ---
            function stabilizeData(newAngle) {
                angleHistory.push(newAngle);
                if (angleHistory.length > historySize) {
                    angleHistory.shift(); 
                }
                
                if (angleHistory.length < 2) {
                    return { stableAngle: newAngle, stabilityPercent: 0 };
                }
                
                // Ortalama (Stabil AÃ§Ä±) hesapla
                const sum = angleHistory.reduce((a, b) => a + b, 0);
                const stableAngle = sum / angleHistory.length;
                
                // KararlÄ±lÄ±k hesapla (Standart sapma ile ters orantÄ±lÄ±)
                const mean = stableAngle;
                const variance = angleHistory.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / angleHistory.length;
                const stdDev = Math.sqrt(variance);
                
                // stdDev 3'ten bÃ¼yÃ¼kse kararlÄ±lÄ±k 0'a yakÄ±n (titreme), 0'a yakÄ±nsa kararlÄ±lÄ±k 100'e yakÄ±n
                let stabilityPercent = 100 * (1 - Math.min(stdDev / 3, 1)); 
                stabilityPercent = Math.max(0, Math.min(100, stabilityPercent)); 
                
                return { stableAngle, stabilityPercent };
            }

            function getAIFeedback(angle, stability) {
                if (angleHistory.length < historySize) return "Kalibrasyon yapÄ±lÄ±yor... LÃ¼tfen sabit tutun.";
                if (stability < 75) return "Eliniz titriyor. CihazÄ± sabit tutmaya Ã§alÄ±ÅŸÄ±n.";
                if (angle < 5) return "Daha yukarÄ± niÅŸan alÄ±n (AÃ§Ä± Ã§ok dÃ¼ÅŸÃ¼k).";
                if (angle > 85) return "Cihaz Ã§ok dik, hedefi kontrol edin (AÃ§Ä± Ã§ok yÃ¼ksek).";
                if (stability > 90) return "Ã–lÃ§Ã¼m stabil, sonuÃ§ gÃ¼venilir.";
                return "Hedefin tepesine niÅŸan alÄ±nÄ±yor...";
            }

            // --- ANA UYGULAMA MANTIÄI ---
            function handleOrientation(event) {
                let rawAngle = event.beta; 
                
                if (rawAngle === null || rawAngle === undefined || rawAngle < NEGATIVE_ANGLE_THRESHOLD) {
                    // Hata durumunda canlÄ± verileri sÄ±fÄ±rla/durdur
                    stopCalculation("Cihaz aÅŸaÄŸÄ± bakÄ±yor veya sensÃ¶r hatasÄ± var!");
                    return;
                }

                let positiveAngle = Math.max(0, rawAngle); 
                positiveAngle = Math.min(90, positiveAngle); 
                
                const { stableAngle, stabilityPercent } = stabilizeData(positiveAngle);
                
                // Hesaplama: Metre cinsinden deÄŸerler kullanÄ±lÄ±yor
                const objectHeightAboveDevice = tan(stableAngle) * distanceMeters;
                const totalHeight = objectHeightAboveDevice + userHeightMeters;
                const feedback = getAIFeedback(stableAngle, stabilityPercent);

                // SÃ¼rekli olarak arayÃ¼zÃ¼ gÃ¼ncelle
                updateLiveUI(stableAngle, totalHeight, stabilityPercent, feedback);
            }
            
            function stopCalculation(aiMessage) {
                heightDisplay.textContent = "--- m";
                angleDisplay.textContent = "---Â°";
                stabilityDisplay.textContent = "0%";
                stabilityBar.style.width = "0%";
                aiFeedback.textContent = `AI: ${aiMessage}`;
                angleHistory = []; 
                crosshairH.style.transform = `translateX(-50%) translateY(-1px)`;
            }
            
            function updateLiveUI(angle, height, stability, feedback) {
                const yShift = -(angle / 90) * 40; 
                crosshairH.style.transform = `translateX(-50%) translateY(calc(-1px + ${yShift}px))`;

                if (angleHistory.length === historySize) {
                    // Filtreleme tamamlandÄ±ÄŸÄ±nda kararlÄ± sonucu gÃ¶ster
                    heightDisplay.textContent = `${height.toFixed(2)} m`;
                    angleDisplay.textContent = `${angle.toFixed(1)}Â°`;
                    stabilityDisplay.textContent = `${stability.toFixed(0)}%`;
                    stabilityBar.style.width = `${stability.toFixed(0)}%`;
                } else {
                    // KararlÄ±lÄ±k iÃ§in veri toplanÄ±rken animasyonlu bekleme gÃ¶ster
                    let calibratingText = ".".repeat(Math.floor(angleHistory.length / (historySize / 4)) + 1);
                    heightDisplay.textContent = calibratingText;
                    angleDisplay.textContent = '...Â°';
                    stabilityDisplay.textContent = '...%';
                    stabilityBar.style.width = '0%';
                }
                aiFeedback.textContent = `AI: ${feedback}`;
            }
            
            function startListening() {
                window.addEventListener('deviceorientation', handleOrientation);
            }

            function stopListening() {
                window.removeEventListener('deviceorientation', handleOrientation);
            }
            
            function resetAppState() {
                stopListening();
                angleHistory = []; 

                setupScreen.classList.remove('hidden');
                measurementScreen.classList.add('hidden');
                permissionStatus.textContent = ""; 
                document.getElementById('liveMeasurementHeader').textContent = "Hedefe niÅŸan alÄ±n ve sonucu anlÄ±k olarak izleyin.";

                stopCalculation("Ã–lÃ§Ã¼m durduruldu."); 
            }

            // --- OLAY DÄ°NLEYÄ°CÄ°LERÄ° ---
            startButton.addEventListener('click', () => {
                // Girdi ve Birimleri Oku
                inputDistanceUnit = document.querySelector('.unit-selector-group[data-target="distance"] .active-unit').getAttribute('data-unit');
                inputUserHeightUnit = document.querySelector('.unit-selector-group[data-target="userHeight"] .active-unit').getAttribute('data-unit');
                
                // GÃ¶rÃ¼ntÃ¼leme deÄŸerlerini sakla (kullanÄ±cÄ±nÄ±n girdiÄŸi formatta)
                inputDistanceValue = parseFloat(distanceInput.value);
                inputUserHeightValue = parseFloat(userHeightInput.value);

                // Hesaplama iÃ§in metreye Ã§evir
                distanceMeters = convertValueToMeters(inputDistanceValue, inputDistanceUnit); 
                userHeightMeters = convertValueToMeters(inputUserHeightValue, inputUserHeightUnit);

                if (distanceMeters <= 0) {
                    permissionStatus.textContent = "LÃ¼tfen geÃ§erli bir uzaklÄ±k deÄŸeri girin.";
                    return;
                }
                if (userHeightMeters < 0) { 
                    permissionStatus.textContent = "LÃ¼tfen geÃ§erli bir cihaz yÃ¼ksekliÄŸi deÄŸeri girin.";
                    return;
                }

                // Girdi Context Panelini GÃ¼ncelle
                contextDistance.textContent = `${formatValue(inputDistanceValue, inputDistanceUnit)} ${inputDistanceUnit}`;
                contextUserHeight.textContent = `${formatValue(inputUserHeightValue, inputUserHeightUnit)} ${inputUserHeightUnit}`;


                permissionStatus.textContent = "SensÃ¶r izni isteniyor...";

                // Cihaz Ä°zin Ä°stemesi
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission()
                        .then(permissionState => {
                            if (permissionState === 'granted') {
                                permissionStatus.textContent = "Ä°zin verildi. BaÅŸlatÄ±lÄ±yor...";
                                startListening();
                                setupScreen.classList.add('hidden');
                                measurementScreen.classList.remove('hidden');
                            } else {
                                permissionStatus.textContent = "SensÃ¶r izni reddedildi. Bu uygulama izin olmadan Ã§alÄ±ÅŸamaz.";
                            }
                        })
                        .catch((error) => {
                            console.error(error);
                            permissionStatus.textContent = "SensÃ¶r izni alÄ±nÄ±rken bir hata oluÅŸtu.";
                        });
                } else {
                    permissionStatus.textContent = "BaÅŸlatÄ±lÄ±yor...";
                    startListening();
                    setupScreen.classList.add('hidden');
                    measurementScreen.classList.remove('hidden');
                }
            });

            resetButton.addEventListener('click', resetAppState);
        });
    </script>
</body>
</html>
