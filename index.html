<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kamera + AÃ§Ä± ile YÃ¼kseklik Ã–lÃ§er</title>
<style>
  body {
    font-family: "Poppins", sans-serif;
    background: linear-gradient(135deg, #012E40, #026773);
    color: #F2E3D5;
    text-align: center;
    padding: 1rem;
  }
  h2 {
    color: #3CA6A6;
  }
  video, canvas {
    width: 100%;
    max-width: 500px;
    border-radius: 12px;
    margin-top: 1rem;
  }
  .panel {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
    display: inline-block;
    padding: 1rem;
    margin-top: 1rem;
  }
  button {
    background: #3CA6A6;
    color: #012E40;
    border: none;
    border-radius: 10px;
    padding: 0.6rem 1.2rem;
    cursor: pointer;
    margin-top: 0.5rem;
  }
  button:hover {
    background: #F2E3D5;
    color: #012E40;
  }
  select, input {
    padding: 0.3rem;
    border-radius: 6px;
    border: none;
    text-align: center;
  }
  #log {
    margin-top: 0.5rem;
    font-size: 0.9rem;
    color: #F2E3D5;
  }
</style>
</head>
<body>
<h2>ðŸ“± Kamera + AÃ§Ä± ile YÃ¼kseklik Ã–lÃ§er</h2>
<p>Telefonu yere paralel tut, cismin tepesine niÅŸan al ve baÅŸlat.</p>

<div class="panel">
  Mesafe (m): <input type="number" id="distance" value="2" step="0.1"><br>
  Telefon YÃ¼ksekliÄŸi (m): <input type="number" id="deviceHeight" value="1.6" step="0.1"><br>
  Ã–lÃ§Ã¼m Birimi:
  <select id="unit">
    <option value="m">Metre</option>
    <option value="cm">Santimetre</option>
    <option value="mm">Milimetre</option>
  </select><br>
  AlgÄ±lama Modu:
  <select id="mode">
    <option value="color">Renk (Ã¶r. kÄ±rmÄ±zÄ± sticker)</option>
    <option value="edge">Kenar</option>
  </select><br>
  <button id="startBtn">ðŸ“· BaÅŸlat</button>
  <button id="stopBtn">ðŸ›‘ Durdur</button>
  <p id="log">HazÄ±r bekliyor...</p>
</div>

<video id="video" autoplay playsinline muted></video>
<canvas id="canvas"></canvas>

<script async src="https://docs.opencv.org/4.x/opencv.js" onload="onCvReady()"></script>
<script>
let video = document.getElementById("video");
let canvas = document.getElementById("canvas");
let ctx = canvas.getContext("2d");
let logEl = document.getElementById("log");
let running = false, cap, src, dst, stream;

// son aÃ§Ä±
window.latestBeta = 0;
window.addEventListener("deviceorientation", e => {
  if (e.beta !== null) window.latestBeta = e.beta;
});

function onCvReady() {
  logEl.innerText = "âœ… OpenCV yÃ¼klendi, hazÄ±r.";
}

async function start() {
  if (running) return;
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    video.srcObject = stream;
    await video.play();
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    src = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
    dst = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC1);
    cap = new cv.VideoCapture(video);
    running = true;
    processFrame();
    logEl.innerText = "ðŸŽ¥ Kamera aktif.";
  } catch (err) {
    logEl.innerText = "Kamera aÃ§Ä±lamadÄ±: " + err;
  }
}

function stop() {
  running = false;
  if (stream) stream.getTracks().forEach(t => t.stop());
  if (src) src.delete();
  if (dst) dst.delete();
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  logEl.innerText = "ðŸ›‘ Durduruldu.";
}

function toRad(deg){ return deg * Math.PI / 180; }

function processFrame() {
  if (!running) return;
  cap.read(src);
  let mode = document.getElementById("mode").value;

  if (mode === "color") {
    let hsv = new cv.Mat();
    cv.cvtColor(src, hsv, cv.COLOR_RGBA2RGB);
    cv.cvtColor(hsv, hsv, cv.COLOR_RGB2HSV);
    let low = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [0, 80, 50, 0]); // kÄ±rmÄ±zÄ± alt
    let high = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [10, 255, 255, 255]); // kÄ±rmÄ±zÄ± Ã¼st
    cv.inRange(hsv, low, high, dst);
    low.delete(); high.delete(); hsv.delete();
  } else {
    let gray = new cv.Mat();
    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
    cv.Canny(gray, dst, 80, 150);
    gray.delete();
  }

  // kontur bul
  let contours = new cv.MatVector();
  let hierarchy = new cv.Mat();
  cv.findContours(dst, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
  let maxArea = 0, maxCnt = null;
  for (let i = 0; i < contours.size(); i++) {
    let cnt = contours.get(i);
    let area = cv.contourArea(cnt);
    if (area > maxArea) { maxArea = area; maxCnt = cnt; }
  }

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  if (maxCnt && maxArea > 200) {
    let topY = Infinity, topX = 0;
    for (let i = 0; i < maxCnt.data32S.length; i += 2) {
      let x = maxCnt.data32S[i], y = maxCnt.data32S[i + 1];
      if (y < topY) { topY = y; topX = x; }
    }

    ctx.strokeStyle = "red";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.arc(topX, topY, 8, 0, Math.PI * 2);
    ctx.stroke();

    let beta = window.latestBeta || 0;
    let d = parseFloat(document.getElementById("distance").value) || 1;
    let z = parseFloat(document.getElementById("deviceHeight").value) || 0;
    let h = z + Math.tan(toRad(beta)) * d;
    let unit = document.getElementById("unit").value;
    if (unit === "cm") h *= 100;
    if (unit === "mm") h *= 1000;

    ctx.fillStyle = "rgba(0,0,0,0.4)";
    ctx.fillRect(10, 10, 300, 60);
    ctx.fillStyle = "#F2E3D5";
    ctx.font = "16px Poppins";
    ctx.fillText(`AÃ§Ä± (Î²): ${beta.toFixed(1)}Â°`, 20, 35);
    ctx.fillText(`YÃ¼kseklik: ${h.toFixed(2)} ${unit}`, 20, 55);

    logEl.innerText = `ðŸŽ¯ Tepe bulundu. AÃ§Ä±=${beta.toFixed(1)}Â°, H=${h.toFixed(2)} ${unit}`;
  } else {
    logEl.innerText = "Hedef bulunamadÄ±, Ä±ÅŸÄ±ÄŸÄ± veya renk kontrastÄ±nÄ± kontrol et.";
  }

  contours.delete(); hierarchy.delete();
  requestAnimationFrame(processFrame);
}

document.getElementById("startBtn").onclick = start;
document.getElementById("stopBtn").onclick = stop;
</script>
</body>
</html>
