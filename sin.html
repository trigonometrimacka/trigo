<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TRIGO PRO - Ultimate Math Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Audiowide&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
        .font-logo { font-family: 'Audiowide', sans-serif; letter-spacing: 1px; }
        
        /* Ã–zel Renkler */
        :root {
            --gold: #fbbf24;
            --neon-green: #32CD32;
            --dark-surface: #1e293b;
        }

        /* Sekme GeÃ§iÅŸ AnimasyonlarÄ± */
        .tab-content { display: none; opacity: 0; transition: opacity 0.3s ease-in-out; }
        .tab-content.active { display: block; opacity: 1; }

        /* YÃ¼kseklik Ã–lÃ§er NiÅŸangahÄ± */
        .crosshair {
            width: 120px; height: 120px; border: 2px dashed rgba(251, 191, 36, 0.5);
            border-radius: 50%; margin: 10px auto; position: relative;
        }
        .crosshair-line-h {
            position: absolute; top: 50%; left: 50%; width: 40px; height: 2px;
            background: #fbbf24; transform: translate(-50%, -50%); box-shadow: 0 0 10px #fbbf24;
            transition: transform 0.1s linear;
        }

        /* Osiloskop Canvas */
        canvas { background: #000; border: 1px solid #334155; border-radius: 8px; width: 100%; }

        /* Slider Stili */
        input[type=range] {
            -webkit-appearance: none; width: 100%; background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: var(--gold); margin-top: -6px; cursor: pointer;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #475569; border-radius: 2px;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <nav class="bg-slate-900 border-b border-slate-700 p-4 sticky top-0 z-50 shadow-lg">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <span class="text-3xl font-logo text-amber-400">TRIGO</span>
                <span class="text-xs text-slate-400 border border-slate-600 px-1 rounded">PRO</span>
            </div>
            
            <div class="flex space-x-1 bg-slate-800 p-1 rounded-lg">
                <button onclick="switchTab('height')" id="btn-height" class="px-3 py-1.5 text-sm rounded-md transition-all bg-amber-500 text-black font-bold shadow">
                    ğŸ“ Ã–lÃ§er
                </button>
                <button onclick="switchTab('sound')" id="btn-sound" class="px-3 py-1.5 text-sm rounded-md transition-all text-slate-300 hover:bg-slate-700">
                    ğŸ™ï¸ Ses Lab
                </button>
                <button onclick="switchTab('edu')" id="btn-edu" class="px-3 py-1.5 text-sm rounded-md transition-all text-slate-300 hover:bg-slate-700">
                    ğŸ“ EÄŸitim
                </button>
            </div>
        </div>
    </nav>

    <main class="flex-grow p-4 max-w-5xl mx-auto w-full">

        <div id="tab-height" class="tab-content active">
            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-xl">
                    <h2 class="text-xl font-bold text-white mb-4 flex items-center">
                        <span class="text-2xl mr-2">ğŸ—ï¸</span> YÃ¼kseklik Hesapla
                    </h2>
                    
                    <div id="height-setup">
                        <label class="text-xs text-slate-400 uppercase tracking-wider">Hedefe UzaklÄ±k (Metre)</label>
                        <input type="number" id="h-distance" value="10" class="w-full bg-slate-900 text-white p-3 rounded-lg border border-slate-600 focus:border-amber-400 focus:outline-none text-lg mb-4 mt-1" placeholder="Ã–rn: 10">
                        
                        <label class="text-xs text-slate-400 uppercase tracking-wider">Telefon YÃ¼ksekliÄŸi (Metre)</label>
                        <input type="number" id="h-user" value="1.70" class="w-full bg-slate-900 text-white p-3 rounded-lg border border-slate-600 focus:border-amber-400 focus:outline-none text-lg mb-6 mt-1" placeholder="Ã–rn: 1.7">

                        <button id="h-start-btn" class="w-full bg-amber-500 hover:bg-amber-400 text-black font-bold py-4 rounded-xl transition shadow-lg shadow-amber-500/20">
                            CANLI Ã–LÃ‡ÃœMÃœ BAÅLAT
                        </button>
                        <p id="h-permission-msg" class="text-center text-xs text-amber-400 mt-2 min-h-[20px]"></p>
                    </div>

                    <div id="height-live" class="hidden text-center mt-4">
                        <div class="crosshair">
                            <div id="crosshair-h" class="crosshair-line-h"></div>
                            <div class="absolute top-1/2 left-1/2 w-0.5 h-full bg-amber-400 transform -translate-x-1/2 -translate-y-1/2 opacity-50"></div>
                        </div>
                        <p class="text-slate-400 text-sm mb-1">Cihaz EÄŸim AÃ§Ä±sÄ±</p>
                        <div id="h-angle" class="text-2xl font-mono text-amber-400">0.0Â°</div>
                        
                        <div class="my-4 p-4 bg-slate-900 rounded-xl border border-amber-500/30">
                            <p class="text-slate-400 text-xs uppercase">Tahmini Bina/Nesne YÃ¼ksekliÄŸi</p>
                            <div id="h-result" class="text-5xl font-bold text-white mt-1">0.00 m</div>
                        </div>

                        <button id="h-stop-btn" class="w-full bg-red-600 hover:bg-red-500 text-white py-2 rounded-lg font-medium">Durdur</button>
                    </div>
                </div>

                <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700">
                    <h3 class="font-bold text-amber-400 mb-2">NasÄ±l Ã‡alÄ±ÅŸÄ±r?</h3>
                    <p class="text-slate-300 text-sm mb-4 leading-relaxed">
                        Bu modÃ¼l, telefonunun <b>jiroskop</b> sensÃ¶rÃ¼nÃ¼ kullanÄ±r. Sen bir binanÄ±n tepesine baktÄ±ÄŸÄ±nda telefonun aÃ§Ä±sÄ±nÄ± (Î¸) Ã¶lÃ§eriz.
                    </p>
                    <div class="bg-slate-900 p-3 rounded border border-slate-600 font-mono text-xs text-green-400 mb-4">
                        h = tan(Î¸) * UzaklÄ±k + Boyunuz
                    </div>
                    <p class="text-slate-400 text-xs">
                        *AI Sabitleyici aktif: El titremeleriniz otomatik olarak filtrelenir.
                    </p>
                </div>
            </div>
        </div>

        <div id="tab-sound" class="tab-content">
            <div class="bg-slate-800 rounded-2xl border border-slate-700 shadow-xl overflow-hidden">
                <div class="p-4 bg-slate-900 border-b border-slate-700 flex flex-wrap gap-2 justify-between items-center">
                    <button id="mic-start-btn" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2">
                        <span>ğŸ™ï¸</span> Mikrofonu AÃ§
                    </button>
                    <div class="flex gap-2">
                        <button id="mic-capture-btn" disabled class="bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-medium">
                            ğŸ“¸ AnlÄ±k Yakala (Analiz)
                        </button>
                        <button id="wav-dl-btn" disabled class="bg-slate-700 disabled:opacity-50 hover:bg-slate-600 text-white px-4 py-2 rounded-lg font-medium">
                            ğŸ’¾ WAV Ä°ndir
                        </button>
                    </div>
                </div>

                <div class="p-4 grid lg:grid-cols-2 gap-4">
                    <div>
                        <div class="flex justify-between text-xs text-green-400 mb-1 font-mono">
                            <span>CANLI SÄ°NYAL</span>
                            <span id="live-fft-info">Detay: Normal</span>
                        </div>
                        <canvas id="liveCanvas" height="200"></canvas>
                    </div>
                    
                    <div>
                        <div class="flex justify-between text-xs text-amber-400 mb-1 font-mono">
                            <span>DONDURULMUÅ ANALÄ°Z</span>
                            <span>Ä°ncelemek iÃ§in tÄ±kla</span>
                        </div>
                        <canvas id="analysisCanvas" height="200" class="cursor-crosshair"></canvas>
                    </div>
                </div>

                <div class="p-4 bg-black border-t border-slate-700 font-mono text-xs text-slate-300 grid md:grid-cols-2 gap-4">
                    <div>
                        <h4 class="text-amber-400 border-b border-slate-600 mb-2">ğŸ“Š Analiz Verileri (TÄ±klanan Nokta)</h4>
                        <pre id="analysis-data" class="whitespace-pre-wrap">HenÃ¼z veri yok. Mikrofonu aÃ§Ä±p 'Yakala' butonuna basÄ±n.</pre>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-slate-500 mb-1">Dalga GeniÅŸletme (Zoom/Scroll)</label>
                            <input type="range" id="scroll-slider" min="0" max="1000" value="0" disabled>
                        </div>
                        <div class="bg-slate-900 p-2 rounded border border-slate-700">
                            <label class="flex items-center gap-2 mb-2">
                                <input type="checkbox" id="show-ref-wave">
                                <span class="text-purple-400">Referans SinÃ¼s DalgasÄ± Ekle</span>
                            </label>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="range" id="freq-slider" min="1" max="50" value="5">
                                <input type="range" id="amp-slider" min="0" max="1" value="0.5" step="0.1">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-edu" class="tab-content">
            <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 mb-6">
                <h2 class="text-2xl font-bold text-amber-400 mb-4">SÄ±fÄ±rdan Trigonometri: HayatÄ±n MatematiÄŸi</h2>
                
                <div class="aspect-video w-full rounded-xl overflow-hidden shadow-2xl mb-6 border border-slate-600">
                    <iframe width="100%" height="100%" src="https://www.youtube.com/embed/TPz9uo9AZ10" title="Trigonometri AnlatÄ±mÄ±" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                </div>

                <div class="space-y-6 text-slate-300">
                    <div class="bg-slate-900 p-4 rounded-lg border-l-4 border-green-500">
                        <h3 class="text-lg font-bold text-white mb-2">1. ÃœÃ§genler (Neden YÃ¼kseklik Ã–lÃ§Ã¼yoruz?)</h3>
                        <p>Trigonometri aslÄ±nda "ÃœÃ§gen Ã–lÃ§Ã¼mÃ¼" demektir. YÃ¼kseklik Ã¶lÃ§er modÃ¼lÃ¼nde kullandÄ±ÄŸÄ±mÄ±z <b>Tanjant (tan)</b> fonksiyonu ÅŸudur:</p>
                        <p class="mt-2 text-green-400 font-mono">Tan(AÃ§Ä±) = KarÅŸÄ± Kenar (YÃ¼kseklik) / KomÅŸu Kenar (UzaklÄ±k)</p>
                        <p class="mt-2 text-sm">Biz aÃ§Ä±yÄ± (telefonla) ve uzaklÄ±ÄŸÄ± (senin girdiÄŸin) biliyoruz. FormÃ¼lÃ¼ terse Ã§evirip yÃ¼ksekliÄŸi buluyoruz.</p>
                    </div>

                    <div class="bg-slate-900 p-4 rounded-lg border-l-4 border-amber-500">
                        <h3 class="text-lg font-bold text-white mb-2">2. Ã‡emberler ve Dalgalar (Ses Nedir?)</h3>
                        <p>Ses laboratuvarÄ±nda gÃ¶rdÃ¼ÄŸÃ¼n o dalgalar aslÄ±nda "aÃ§Ä±lmÄ±ÅŸ Ã§emberlerdir".</p>
                        <ul class="list-disc pl-5 mt-2 space-y-1 text-sm">
                            <li><b>SinÃ¼s (sin):</b> Bir tekerleÄŸin Ã¼zerindeki noktanÄ±n yukarÄ±-aÅŸaÄŸÄ± hareketidir.</li>
                            <li>Ses dalgasÄ± aslÄ±nda havadaki basÄ±ncÄ±n <b>SinÃ¼s</b> grafiÄŸidir.</li>
                            <li>Osiloskopta gÃ¶rdÃ¼ÄŸÃ¼n o tepe ve Ã§ukurlar, trigonometrik fonksiyonlarÄ±n gÃ¶rsel halidir.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <footer class="bg-slate-900 text-slate-500 text-center p-4 text-xs border-t border-slate-700 mt-auto">
        <p>TRIGO AI &copy; 2025 - Mathematical Engineering Tools</p>
    </footer>

    <script>
        // === GLOBAL DEÄÄ°ÅKENLER VE AYARLAR ===
        let activeTab = 'height';

        // --- YÃœKSEKLÄ°K Ã–LÃ‡ER DEÄÄ°ÅKENLERÄ° ---
        let heightWatching = false;
        const hOutput = document.getElementById('h-result');
        const hAngleOut = document.getElementById('h-angle');
        const hCrosshair = document.getElementById('crosshair-h');
        const hSetupDiv = document.getElementById('height-setup');
        const hLiveDiv = document.getElementById('height-live');
        let hAngleHistory = [];

        // --- SES LAB DEÄÄ°ÅKENLERÄ° ---
        let audioCtx, analyser, micSource, liveReqId;
        const liveCanvas = document.getElementById('liveCanvas');
        const analysisCanvas = document.getElementById('analysisCanvas');
        const lCtx = liveCanvas.getContext('2d');
        const aCtx = analysisCanvas.getContext('2d');
        let capturedBuffer = new Float32Array(8192); 
        let liveData = new Float32Array(1024);
        let isMicOn = false;

        // === SEKME SÄ°STEMÄ° ===
        function switchTab(tabName) {
            // UI GÃ¼ncelleme
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            
            // Buton Stilleri
            ['height', 'sound', 'edu'].forEach(t => {
                const btn = document.getElementById('btn-' + t);
                if(t === tabName) {
                    btn.classList.remove('text-slate-300', 'hover:bg-slate-700');
                    btn.classList.add('bg-amber-500', 'text-black', 'font-bold', 'shadow');
                } else {
                    btn.classList.add('text-slate-300', 'hover:bg-slate-700');
                    btn.classList.remove('bg-amber-500', 'text-black', 'font-bold', 'shadow');
                }
            });

            activeTab = tabName;
            
            // Sekme deÄŸiÅŸince gereksiz iÅŸlemleri durdur
            if(tabName !== 'height' && heightWatching) stopHeightMeasure();
            // Not: Mikrofonu arka planda aÃ§Ä±k bÄ±rakabiliriz, kullanÄ±cÄ± isterse kapatsÄ±n.
        }

        // ==========================================
        // 1. MODÃœL MANTIÄI: YÃœKSEKLÄ°K Ã–LÃ‡ER
        // ==========================================
        document.getElementById('h-start-btn').addEventListener('click', () => {
            const dist = parseFloat(document.getElementById('h-distance').value);
            const userH = parseFloat(document.getElementById('h-user').value);

            if(!dist || !userH || dist <= 0) {
                alert("LÃ¼tfen geÃ§erli bir uzaklÄ±k ve boy girin.");
                return;
            }

            // Ä°zin Ä°steÄŸi (iOS 13+ iÃ§in)
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(state => {
                        if (state === 'granted') startHeightMeasure();
                        else alert("SensÃ¶r izni reddedildi.");
                    })
                    .catch(console.error);
            } else {
                startHeightMeasure();
            }
        });

        document.getElementById('h-stop-btn').addEventListener('click', stopHeightMeasure);

        function startHeightMeasure() {
            hSetupDiv.classList.add('hidden');
            hLiveDiv.classList.remove('hidden');
            window.addEventListener('deviceorientation', handleOrientation);
            heightWatching = true;
        }

        function stopHeightMeasure() {
            window.removeEventListener('deviceorientation', handleOrientation);
            hSetupDiv.classList.remove('hidden');
            hLiveDiv.classList.add('hidden');
            heightWatching = false;
            hAngleHistory = [];
        }

        function handleOrientation(e) {
            if(!heightWatching) return;
            
            let beta = e.beta; // CihazÄ±n Ã¶ne-arkaya eÄŸimi (-180 ile 180 arasÄ±)
            if(beta === null) return;

            // Beta'yÄ± 0-90 arasÄ± normalize et (sadece yukarÄ± bakÄ±ÅŸ)
            if(beta < 0) beta = 0; 
            if(beta > 90) beta = 90;

            // Basit Ortalama Alma (Smoothing)
            hAngleHistory.push(beta);
            if(hAngleHistory.length > 20) hAngleHistory.shift();
            const smoothBeta = hAngleHistory.reduce((a,b)=>a+b,0) / hAngleHistory.length;

            // Hesaplama
            const dist = parseFloat(document.getElementById('h-distance').value);
            const userH = parseFloat(document.getElementById('h-user').value);
            
            // h = tan(aÃ§Ä±) * d + boy
            // Math.tan radyan ister!
            const rad = smoothBeta * (Math.PI / 180);
            const height = (Math.tan(rad) * dist) + userH;

            // UI GÃ¼ncelleme
            hAngleOut.innerText = smoothBeta.toFixed(1) + "Â°";
            hOutput.innerText = height.toFixed(2) + " m";
            
            // NiÅŸangah Hareketi
            // 90 derecede 40px yukarÄ± kaysÄ±n
            const movePx = (smoothBeta / 90) * 40;
            hCrosshair.style.transform = `translate(-50%, calc(-50% - ${movePx}px))`;
        }


        // ==========================================
        // 2. MODÃœL MANTIÄI: SES LAB & OSÄ°LOSKOP
        // ==========================================
        const micBtn = document.getElementById('mic-start-btn');
        const capBtn = document.getElementById('mic-capture-btn');
        const dlBtn = document.getElementById('wav-dl-btn');

        micBtn.addEventListener('click', async () => {
            if(isMicOn) {
                // Durdur
                if(audioCtx) audioCtx.close();
                cancelAnimationFrame(liveReqId);
                isMicOn = false;
                micBtn.innerHTML = "<span>ğŸ™ï¸</span> Mikrofonu AÃ§";
                micBtn.classList.replace('bg-red-600', 'bg-green-600');
                capBtn.disabled = true;
                drawGrid(lCtx, liveCanvas.width, liveCanvas.height, "Mikrofon KapalÄ±");
            } else {
                // BaÅŸlat
                try {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    micSource = audioCtx.createMediaStreamSource(stream);
                    analyser = audioCtx.createAnalyser();
                    analyser.fftSize = 2048;
                    micSource.connect(analyser);
                    
                    isMicOn = true;
                    micBtn.innerHTML = "<span>ğŸ›‘</span> Durdur";
                    micBtn.classList.replace('bg-green-600', 'bg-red-600');
                    capBtn.disabled = false;
                    
                    drawLive();
                } catch(err) {
                    alert("Mikrofon hatasÄ±: " + err);
                }
            }
        });

        function drawLive() {
            if(!isMicOn) return;
            liveReqId = requestAnimationFrame(drawLive);
            
            analyser.getFloatTimeDomainData(liveData);
            
            const w = liveCanvas.width;
            const h = liveCanvas.height;
            
            lCtx.fillStyle = '#000';
            lCtx.fillRect(0, 0, w, h);
            drawGrid(lCtx, w, h);
            
            lCtx.lineWidth = 2;
            lCtx.strokeStyle = '#32CD32'; // Neon YeÅŸil
            lCtx.beginPath();
            
            const sliceW = w / liveData.length;
            let x = 0;
            for(let i=0; i<liveData.length; i++) {
                const v = liveData[i]; 
                const y = (v * h/2) + h/2;
                if(i===0) lCtx.moveTo(x,y);
                else lCtx.lineTo(x,y);
                x += sliceW;
            }
            lCtx.stroke();
        }

        // Yakalama (Capture)
        capBtn.addEventListener('click', () => {
            if(!analyser) return;
            // Daha bÃ¼yÃ¼k buffer iÃ§in FFT bÃ¼yÃ¼t
            const oldSize = analyser.fftSize;
            analyser.fftSize = 16384; 
            analyser.getFloatTimeDomainData(capturedBuffer);
            analyser.fftSize = oldSize; // Geri al
            
            drawAnalysis();
            dlBtn.disabled = false;
            document.getElementById('scroll-slider').disabled = false;
            document.getElementById('analysis-data').innerText = "Veri yakalandÄ±. Ä°ncelemek iÃ§in grafiÄŸe tÄ±klayÄ±n.";
        });

        // Ã‡izim YardÄ±mcÄ±larÄ±
        function drawGrid(ctx, w, h, text) {
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(0, h/2); ctx.lineTo(w, h/2);
            ctx.stroke();
            if(text) {
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.fillText(text, w/2, h/2 - 10);
            }
        }

        // Analiz Ã‡izimi
        const scrollSlider = document.getElementById('scroll-slider');
        const showRef = document.getElementById('show-ref-wave');
        const freqS = document.getElementById('freq-slider');
        const ampS = document.getElementById('amp-slider');

        [scrollSlider, showRef, freqS, ampS].forEach(el => el.addEventListener('input', drawAnalysis));

        function drawAnalysis() {
            const w = analysisCanvas.width;
            const h = analysisCanvas.height;
            const offset = parseInt(scrollSlider.value) * 5; // HÄ±z Ã§arpanÄ±
            
            aCtx.fillStyle = '#000';
            aCtx.fillRect(0,0,w,h);
            drawGrid(aCtx, w, h);

            // Ana Sinyal
            aCtx.strokeStyle = '#fbbf24'; // AltÄ±n
            aCtx.beginPath();
            const viewSize = 1024; // Ekranda gÃ¶rÃ¼nen nokta sayÄ±sÄ±
            const sliceW = w / viewSize;
            
            for(let i=0; i<viewSize; i++) {
                const idx = i + offset;
                if(idx >= capturedBuffer.length) break;
                
                const val = capturedBuffer[idx];
                const y = (val * h/2) + h/2;
                if(i===0) aCtx.moveTo(i*sliceW, y);
                else aCtx.lineTo(i*sliceW, y);
            }
            aCtx.stroke();

            // Referans Sinyal
            if(showRef.checked) {
                aCtx.strokeStyle = 'rgba(255, 0, 255, 0.7)';
                aCtx.beginPath();
                const freq = parseInt(freqS.value);
                const amp = parseFloat(ampS.value);
                
                for(let i=0; i<w; i++) {
                    const t = i/w; // 0 ile 1 arasÄ±
                    const val = Math.sin(t * Math.PI * 2 * freq) * amp;
                    const y = (val * h/2) + h/2;
                    if(i===0) aCtx.moveTo(i,y);
                    else aCtx.lineTo(i,y);
                }
                aCtx.stroke();
            }
        }

        // TÄ±klama ile Trigonometrik Analiz
        analysisCanvas.addEventListener('click', (e) => {
            if(capturedBuffer[0] === 0) return;
            const rect = analysisCanvas.getBoundingClientRect();
            // Canvas Ã¶lÃ§eklemesi sorunu iÃ§in scale hesabÄ±
            const scaleX = analysisCanvas.width / rect.width;
            const x = (e.clientX - rect.left) * scaleX;
            
            const viewSize = 1024;
            const sliceW = analysisCanvas.width / viewSize;
            const clickedIndex = Math.floor(x / sliceW);
            const offset = parseInt(scrollSlider.value) * 5;
            const realIndex = clickedIndex + offset;
            
            if(realIndex < 1 || realIndex >= capturedBuffer.length-1) return;

            const yCurr = capturedBuffer[realIndex];
            const yPrev = capturedBuffer[realIndex-1];
            const yNext = capturedBuffer[realIndex+1];
            
            // EÄŸim (Derivative) -> Tanjant
            const slope = (yNext - yPrev) / 2;
            const angleRad = Math.atan(slope);
            const angleDeg = angleRad * (180/Math.PI);

            document.getElementById('analysis-data').innerText = `
SEÃ‡Ä°LEN NOKTA ANALÄ°ZÄ°:
----------------------
Genlik (y) : ${yCurr.toFixed(4)}
EÄŸim (m)   : ${slope.toFixed(4)} (AnlÄ±k DeÄŸiÅŸim HÄ±zÄ±)

TRIGONOMETRÄ°:
tan(Î¸) = ${slope.toFixed(4)}
AÃ§Ä±(Î¸) = ${angleDeg.toFixed(2)}Â°
sin(Î¸) = ${Math.sin(angleRad).toFixed(4)}
cos(Î¸) = ${Math.cos(angleRad).toFixed(4)}
            `.trim();
            
            // TÄ±klanan yere nokta koy
            drawAnalysis(); // Temizle
            const yPix = (yCurr * analysisCanvas.height/2) + analysisCanvas.height/2;
            aCtx.fillStyle = 'red';
            aCtx.beginPath();
            aCtx.arc(clickedIndex * sliceW, yPix, 4, 0, Math.PI*2);
            aCtx.fill();
        });

        // WAV Ä°ndirme
        dlBtn.addEventListener('click', () => {
            if(capturedBuffer[0] === 0) return;
            const wavData = encodeWAV(capturedBuffer, audioCtx.sampleRate);
            const blob = new Blob([wavData], { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'trigo_capture.wav';
            a.click();
        });

        function encodeWAV(samples, sampleRate) {
            const buffer = new ArrayBuffer(44 + samples.length * 2);
            const view = new DataView(buffer);
            const writeString = (view, offset, string) => {
                for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
            };

            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + samples.length * 2, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, samples.length * 2, true);

            let offset = 44;
            for (let i = 0; i < samples.length; i++, offset += 2) {
                let s = Math.max(-1, Math.min(1, samples[i]));
                s = s < 0 ? s * 0x8000 : s * 0x7FFF;
                view.setInt16(offset, s, true);
            }
            return view;
        }
        
        // BaÅŸlangÄ±Ã§ AyarÄ±: Gridleri Ã§iz
        window.onload = () => {
             drawGrid(lCtx, liveCanvas.width, liveCanvas.height, "Mikrofon Bekleniyor");
             drawGrid(aCtx, analysisCanvas.width, analysisCanvas.height, "Analiz Bekleniyor");
             // Canvas resolution fix
             [liveCanvas, analysisCanvas].forEach(c => {
                 c.width = c.clientWidth; 
                 c.height = 200; 
             });
        };
    </script>
</body>
</html>
