<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Osiloskop (Yeni TasarÄ±m) ve Trigonometrik Analiz</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        :root {
            /* YENÄ° ESTETÄ°K RENK PALETÄ° (Modern StÃ¼dyo TemasÄ±) */
            --bg-deep-dark: #0d1117;     /* En koyu arka plan */
            --bg-dark: #161b22;         /* Panel arka planÄ± */
            --bg-medium: #21262d;     /* Vurgulu arka plan (hover vb.) */
            --border-color: #30363d;      /* Paneller iÃ§in kenarlÄ±k */
            
            --text-primary: #e6edf3;    /* Ana metin rengi */
            --text-secondary: #8b949e;  /* Ä°kincil metin (etiketler, baÅŸlÄ±klar) */
            
            --accent-blue: #388bfd;       /* Ana Vurgu Rengi (Mavi) */
            --accent-blue-hover: #58a6ff;
            --accent-blue-glow: rgba(58, 139, 253, 0.4);

            /* Dalga Renkleri */
            --wave-captured: #f1e05a;    /* Yakalanan Dalga (SarÄ±) */
            --wave-reference: #f72585;   /* Referans Dalga (Macenta) */
            --wave-live: #32CD32;         /* CanlÄ± Dalga (Orijinal YeÅŸil) */

            /* DiÄŸer */
            --disabled-bg: #21262d;
            --disabled-text: #484f58;
            --danger-red: #f85149;
        }

        body {
            background-color: var(--bg-deep-dark);
            color: var(--text-primary);
            font-family: 'Open Sans', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 25px;
            box-sizing: border-box;
            line-height: 1.6;
        }

        /* Ana Konteyner */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 25px; /* BÃ¶lÃ¼mler arasÄ± boÅŸluk */
        }

        h1, h2, h3 {
            color: var(--text-primary);
            font-weight: 600;
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        h1 {
            text-align: center;
            font-size: 2.2em;
            color: var(--accent-blue);
            text-shadow: 0 0 10px var(--accent-blue-glow);
        }

        h2 {
            font-size: 1.5em;
            color: var(--text-secondary);
        }
        
        h3 {
             color: var(--accent-blue);
             border-bottom: none;
             font-size: 1.1em;
             margin-bottom: 10px;
        }

        /* Ana Panel Stili */
        .panel {
            background-color: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            width: 100%;
            box-sizing: border-box;
        }
        
        /* Monospace (Kod/Veri) Font Ailesi */
        .monospace {
             font-family: 'Roboto Mono', 'Consolas', 'Courier New', monospace;
        }

        /* YENÄ° DÃœZEN: Ana Kontrol Paneli */
        .kontrol-paneli {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between; /* ButonlarÄ± ve kaydÄ±racÄ± ayÄ±r */
            align-items: center;
            gap: 20px;
            padding: 20px 25px;
        }
        
        .kontrol-paneli-grup {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        /* YENÄ° DÃœZEN: OsiloskoplarÄ± ve SonuÃ§larÄ± tutan Grid yapÄ± */
        .grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Ä°ki eÅŸit sÃ¼tun */
            gap: 25px;
        }

        /* DÃ¼ÄŸme Stilleri (Modern) */
        button {
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }
        
        #startStopButton {
            background-color: var(--accent-blue);
            color: #ffffff;
            box-shadow: 0 4px 14px var(--accent-blue-glow);
        }
        #startStopButton:hover {
            background-color: var(--accent-blue-hover);
        }
        #startStopButton:active {
             transform: translateY(1px);
        }
        
        /* Durdurma modu iÃ§in (JS tarafÄ±ndan eklenecek) */
        #startStopButton.stop-mode {
            background-color: var(--danger-red);
            box-shadow: 0 4px 14px rgba(248, 81, 73, 0.4);
        }

        /* "Hayalet" DÃ¼ÄŸme stili */
        #captureButton {
            background-color: transparent;
            color: var(--accent-blue);
            border: 2px solid var(--accent-blue);
        }
        #captureButton:not(:disabled):hover {
            background-color: var(--accent-blue-glow);
            color: var(--accent-blue-hover);
        }
        
        button:disabled {
            background-color: var(--disabled-bg);
            color: var(--disabled-text);
            border-color: var(--disabled-bg);
            cursor: not-allowed;
            box-shadow: none;
        }
        
        /* Osiloskop Bilgi KutularÄ± (Canvas Ã¼stÃ¼) */
        .osiloskop-bilgi {
            background: rgba(0,0,0,0.2);
            color: var(--text-secondary);
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-align: right;
        }

        canvas {
            background-color: #000;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 100%;
            height: 250px; /* YÃ¼ksekliÄŸi biraz artÄ±ralÄ±m */
            box-sizing: border-box;
            box-shadow: 0 0 15px rgba(0,0,0,0.5) inset;
        }

        #analysisCanvas {
            cursor: crosshair;
        }

        /* YENÄ° KAYDIRAÃ‡ (SLIDER) STÄ°LLERÄ° */
        .slider-grup {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        
        .slider-grup label {
            font-size: 0.9em;
            font-weight: 600;
            color: var(--text-secondary);
            display: block;
            margin-bottom: 12px;
        }
        
        .slider-etiket-konteyner {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: var(--bg-medium);
            outline: none;
            transition: opacity .2s;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent-blue);
            border: 3px solid #ffffff;
            box-shadow: 0 0 8px var(--accent-blue-glow);
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
             background: var(--accent-blue-hover);
        }

        input[type="range"]::-moz-range-thumb {
             width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent-blue);
            border: 3px solid #ffffff;
            box-shadow: 0 0 8px var(--accent-blue-glow);
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        /* Checkbox Stili */
        .checkbox-grup {
             display: flex;
             align-items: center;
             gap: 10px;
             color: var(--text-primary);
             font-weight: 600;
        }
        .checkbox-grup input[type="checkbox"] {
            width: 1.2em;
            height: 1.2em;
            accent-color: var(--accent-blue);
        }
        
        /* Referans Dalga Kontrolleri iÃ§in gruplama */
        .referans-kontroller {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
            padding-left: 25px; /* Checkbox ile hizala */
        }
        
        /* SONUÃ‡ PANELLERÄ° (ESTETÄ°K GÃœNCELLEME) */
        #trigPanel {
            background-color: #0d1117; /* Daha koyu */
            border: 1px solid var(--border-color);
        }
        
        #trigPanel pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            color: var(--text-secondary);
            font-size: 1.1em;
            line-height: 1.8;
        }
        
        /* Veri vurgulama iÃ§in span'ler (JS'in bunlarÄ± oluÅŸturmasÄ± GEREKMEZ, sadece PRE iÃ§ine yazmasÄ± yeterli) */
        /* JS'in Ã¼rettiÄŸi metni estetik hale getirmek iÃ§in JS'i DEÄÄ°ÅTÄ°RDÄ°K */
        #analysisData .label, #refWaveData .label {
            color: var(--text-secondary);
        }
        #analysisData .value, #refWaveData .value {
            color: var(--wave-captured);
            font-weight: 500;
        }
        #analysisData .value-emphasis {
            color: var(--accent-blue);
            font-weight: 700;
            font-size: 1.1em;
        }
        #refWaveData .value-emphasis {
            color: var(--wave-reference);
            font-weight: 700;
        }

        /* AKORDÄ°YON STÄ°LLERÄ° (Yeni TasarÄ±m) */
        .accordion {
            background-color: var(--bg-medium);
            color: var(--text-primary);
            cursor: pointer;
            padding: 18px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 1.1em;
            transition: background-color 0.4s;
            border-radius: 8px;
            font-weight: 600;
        }

        .active, .accordion:hover {
            background-color: #30363d;
        }

        .accordion::before {
            content: '+';
            font-weight: bold;
            color: var(--accent-blue);
            float: right;
            margin-left: 15px;
            font-size: 1.2em;
            transition: transform 0.2s ease-out;
        }

        .active::before {
            content: "âˆ’";
            transform: rotate(180deg);
        }

        .accordion-panel {
            padding: 0 18px;
            background-color: var(--bg-dark);
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
            border-bottom: 1px solid var(--border-color);
            border-radius: 0 0 8px 8px;
        }
        .accordion-panel p, .accordion-panel ol {
            line-height: 1.7;
            color: var(--text-secondary);
            padding-top: 10px;
        }
         .accordion-panel li {
            margin-bottom: 8px;
         }

        /* DUYARLILIK (RESPONSIVE) */
        @media (max-width: 1100px) {
            .grid-container {
                grid-template-columns: 1fr; /* SÃ¼tunlarÄ± dikeyde yÄ±ÄŸ */
            }
        }
        
        @media (max-width: 768px) {
             body {
                padding: 15px;
             }
             .kontrol-paneli {
                 flex-direction: column;
                 align-items: stretch;
             }
             .kontrol-paneli-grup {
                 flex-direction: column;
                 width: 100%;
             }
             .kontrol-paneli-grup button {
                 width: 100%;
             }
             .slider-grup {
                 width: 100%;
             }
             .referans-kontroller {
                grid-template-columns: 1fr;
             }
             h1 {
                font-size: 1.8em;
             }
        }

    </style>
</head>
<body>

    <div class="main-container">

        <h1>ğŸ”Š Pro Osiloskop ve Trigonometrik Analiz ğŸš€</h1>

        <div class="panel kontrol-paneli">
            <div class="kontrol-paneli-grup">
                <button id="startStopButton">ğŸ™ï¸ Mikrofonu BaÅŸlat</button>
                <button id="captureButton" disabled>ğŸ“¸ AnlÄ±k Ses Yakala (Analiz Et)</button>
            </div>
            
            <div class="slider-grup" style="margin: 0; padding: 0; border: none; flex-grow: 1; max-width: 400px;">
                <label for="fftSlider">CanlÄ± Dalga DetayÄ± (FFT Boyutu)</label>
                <input type="range" id="fftSlider" min="0" max="5" value="2">
                <div class="slider-etiket-konteyner">
                    <span>HÄ±zlÄ± / Az Detay</span>
                    <span>YavaÅŸ / Ã‡ok Detay</span>
                </div>
            </div>
        </div>

        <div class="grid-container">
            
            <div class="panel">
                <h2>CanlÄ± AkÄ±ÅŸ</h2>
                <div class="osiloskop-bilgi monospace" id="liveInfo">Detay: 2048</div>
                <canvas id="liveCanvas"></canvas>
                </div>

            <div class="panel">
                <h2>Analiz EkranÄ±</h2>
                <div class="osiloskop-bilgi monospace" id="analysisInfo">Toplam Yakalanan SÃ¼re: --- ms</div>
                <canvas id="analysisCanvas"></canvas>
                
                <div class="slider-grup">
                    <label for="scrollSlider">Yakalanan Sesi KaydÄ±r (Ä°leri/Geri Sar)</label>
                    <input type="range" id="scrollSlider" min="0" max="1000" value="0">
                </div>

                <div class="slider-grup">
                    <label class="checkbox-grup">
                        <input type="checkbox" id="showRefWave"> Referans SinÃ¼s DalgasÄ±nÄ± GÃ¶ster
                    </label>
                    
                    <div class="referans-kontroller">
                        <div style="flex-basis: 50%;">
                            <label for="freqSlider">Frekans (DÃ¶ngÃ¼ SayÄ±sÄ±)</label>
                            <input type="range" id="freqSlider" min="1" max="50" value="5">
                        </div>
                        <div style="flex-basis: 50%;">
                            <label for="ampSlider">Genlik (YÃ¼kseklik)</label>
                            <input type="range" id="ampSlider" min="0" max="1" value="0.5" step="0.01">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel" id="trigPanel">
             <div class="grid-container">
                <div>
                    <h3>ğŸ“‰ Noktasal AkÄ±ÅŸ HÄ±zÄ± (EÄŸim)</h3>
                    <pre id="analysisData" class="monospace">
<span class="label">TÄ±kladÄ±ÄŸÄ±n Nokta:</span>
  <span class="label">Zaman (t):</span>  <span class="value">---</span>
  <span class="label">Genlik (y):</span> <span class="value">---</span>

<span class="label">Nokta EÄŸim (TeÄŸet) Bilgileri:</span>
  <span class="label">EÄŸim (m) - **AKIÅ HIZI**:</span> <span class="value-emphasis">---</span>
  <span class="label">AÃ§Ä± (Î¸) [Radyan]:</span>       <span class="value">---</span>
  <span class="label">AÃ§Ä± (Î¸) [Derece]:</span>       <span class="value">---</span>

<span class="label">Trigonometrik DeÄŸerler:</span>
  <span class="label">tan(Î¸):</span> <span class="value">---</span>
  <span class="label">sin(Î¸):</span> <span class="value">---</span>
  <span class="label">cos(Î¸):</span> <span class="value">---</span>
  <span class="label">cot(Î¸):</span> <span class="value">---</span>
                    </pre>
                </div>

                <div>
                    <h3>ğŸ§® Referans Dalga Bilgisi</h3>
                    <pre id="refWaveData" class="monospace">
<span class="label">Ayarlar:</span>
  <span class="label">Frekans (f):</span> <span class="value-emphasis">--- (DÃ¶ngÃ¼/Ekran)</span>
  <span class="label">Genlik (A):</span>  <span class="value-emphasis">---</span>

<span class="label">Hesaplamalar:</span>
  <span class="label">Periyot (T):</span> <span class="value-emphasis">--- (Ekran GeniÅŸliÄŸi / f)</span>
  
<span class="label">Dalga Denklemi:</span>
  <span class="label">y(t) = A * sin(2 * Ï€ * f * t)</span>
                    </pre>
                </div>
            </div>
        </div>

        <div class="panel">
            <button class="accordion">Bu Site Ne Ä°ÅŸe Yarar? (Ã–zet)</button>
            <div class="accordion-panel">
                <p>Bu araÃ§, sesinizi profesyonel bir osiloskop gibi analiz etmenizi saÄŸlar. Sesi sadece canlÄ± gÃ¶stermekle kalmaz, 'Yakala' butonuna bastÄ±ÄŸÄ±nÄ±zda sesin bÃ¼yÃ¼k bir parÃ§asÄ±nÄ± (yaklaÅŸÄ±k 186 milisaniye) hafÄ±zaya alÄ±r. Bu yakalanan ses Ã¼zerinde **ileri-geri sarma** yaparak gezinebilir ve tÄ±kladÄ±ÄŸÄ±nÄ±z noktanÄ±n eÄŸimini (yani `tan(Î¸)` deÄŸerini) anÄ±nda hesaplayabilirsiniz.</p>
            </div>

            <button class="accordion">NasÄ±l KullanÄ±lÄ±r? (AdÄ±m AdÄ±m)</button>
            <div class="accordion-panel">
                <ol>
                    <li><strong>BaÅŸlat:</strong> 'ğŸ™ï¸ Mikrofonu BaÅŸlat' butonuna basÄ±n ve izin verin.</li>
                    <li><strong>Ä°zle:</strong> 'CanlÄ± AkÄ±ÅŸ' ekranÄ±nda sesi izleyin. 'Dalga DetayÄ± (FFT)' kaydÄ±racÄ± ile canlÄ± akÄ±ÅŸÄ±n hÄ±zÄ±nÄ±/detayÄ±nÄ± ayarlayÄ±n.</li>
                    <li><strong>Yakala:</strong> 'ğŸ“¸ AnlÄ±k Ses Yakala' butonuna basÄ±n. O anki ses, "Analiz EkranÄ±"na aktarÄ±lacaktÄ±r.</li>
                    <li><strong>Geri/Ä°leri Sar:</strong> 'Analiz EkranÄ±' altÄ±ndaki 'Yakalanan Sesi KaydÄ±r (Ä°leri/Geri Sar)' kaydÄ±racÄ± ile hafÄ±zaya alÄ±nan sesin iÃ§inde gezinin.</li>
                    <li><strong>Analiz Et:</strong> SarÄ± dalga Ã¼zerinde bir noktaya tÄ±klayÄ±n.</li>
                    <li><strong>Hesapla:</strong> 'Noktasal AkÄ±ÅŸ HÄ±zÄ±' panelinde o noktanÄ±n eÄŸim (AkÄ±ÅŸ HÄ±zÄ±), aÃ§Ä± ve trigonometrik ($\sin$, $\cos$, $\tan$) deÄŸerlerini gÃ¶rÃ¼n.</li>
                    <li><strong>Referans Ekle:</strong> 'Analiz EkranÄ±'ndaki 'Referans SinÃ¼s DalgasÄ±' kontrolleri ile kendi dalganÄ±zÄ± oluÅŸturup yakaladÄ±ÄŸÄ±nÄ±z sesle karÅŸÄ±laÅŸtÄ±rÄ±n.</li>
                </ol>
            </div>

            <button class="accordion">Trigonometri Bu Ä°ÅŸin Neresinde?</button>
            <div class="accordion-panel">
                <p>EÄŸim, hÄ±z demektir. Sesin eÄŸimi, sesin o anda ne kadar hÄ±zlÄ± deÄŸiÅŸtiÄŸini gÃ¶sterir. Trigonometride ise eÄŸim, **Tanjant (tan)** demektir.</p>
                <p style="font-family: 'Consolas', monospace; font-size: 1.2em; text-align: center; color: var(--accent-blue);">
                    EÄŸim (m) = tan(Î¸)
                </p>
                <p>AyrÄ±ca, eklediÄŸiniz 'Referans SinÃ¼s DalgasÄ±'nÄ±n frekansÄ±nÄ± ($f$) siz belirlersiniz. Biz de o dalganÄ±n **Periyodunu ($T$)** hesaplarÄ±z. Ã‡Ã¼nkÃ¼ aralarÄ±nda doÄŸrudan trigonometrik bir iliÅŸki vardÄ±r: $T = 1/f$.</p>
            </div>
        </div>

    </div>
    
    <script>
        "use strict";

        // === 1. DOM ELEMANLARI ve AYARLAR ===
        // YENÄ°: CSS Renk DeÄŸiÅŸkenlerini JS'te yakala
        const style = getComputedStyle(document.body);
        const LIVE_WAVE_RENK = style.getPropertyValue('--wave-live').trim() || "#32CD32";
        const CAPTURED_WAVE_RENK = style.getPropertyValue('--wave-captured').trim() || "#f1e05a";
        const REF_WAVE_RENK = style.getPropertyValue('--wave-reference').trim() || "#f72585";
        const GRID_RENK_ANA = style.getPropertyValue('--accent-blue-glow').trim() || "rgba(50, 205, 50, 0.7)";
        const GRID_RENK_IKINCIL = style.getPropertyValue('--border-color').trim() || "rgba(50, 205, 50, 0.3)";

        const startStopButton = document.getElementById('startStopButton');
        const captureButton = document.getElementById('captureButton');
        const liveCanvas = document.getElementById('liveCanvas');
        const analysisCanvas = document.getElementById('analysisCanvas');
        const analysisDataPre = document.getElementById('analysisData');
        const refWaveDataPre = document.getElementById('refWaveData');
        const fftSlider = document.getElementById('fftSlider');
        const liveInfo = document.getElementById('liveInfo');
        const analysisInfo = document.getElementById('analysisInfo');
        
        const scrollSlider = document.getElementById('scrollSlider');
        const showRefWaveCheck = document.getElementById('showRefWave');
        const freqSlider = document.getElementById('freqSlider');
        const ampSlider = document.getElementById('ampSlider');
        
        const liveCtx = liveCanvas.getContext('2d');
        const analysisCtx = analysisCanvas.getContext('2d');

        // === 2. DEÄÄ°ÅKENLER ===
        let audioContext;
        let analyser;
        let sourceNode;
        let liveDataArray;
        
        const CAPTURE_BUFFER_SIZE = 8192;
        const ANALYSIS_VIEW_WIDTH = 2048;
        let capturedDataBuffer = new Float32Array(CAPTURE_BUFFER_SIZE);
        let analysisOffset = 0;

        let liveAnimationId;
        let isListening = false;
        
        const fftMap = [512, 1024, 2048, 4096, 8192, 16384];
        let currentLiveFftSize = fftMap[fftSlider.value];
        
        // Kanvas boyutlarÄ± CSS'den alÄ±nÄ±r (width: 100%)
        // JS'te Ã§Ã¶zÃ¼nÃ¼rlÃ¼ÄŸÃ¼ ayarlamamÄ±z gerekir
        function resizeCanvases() {
            [liveCanvas, analysisCanvas].forEach(c => {
                const rect = c.getBoundingClientRect();
                c.width = rect.width;
                c.height = rect.height; // CSS'te 250px olarak ayarlandÄ±
            });
            // Yeniden boyutlandÄ±rmadan sonra mevcut durumu tekrar Ã§iz
            drawGrid(liveCtx, "BaÅŸlat'a bas.");
            drawGrid(analysisCtx, "Yakalanan ses buraya gelir.");
            if (capturedDataBuffer[0] !== 0) drawAnalysisWave();
        }

        // === 3. Ã‡ALIÅMA MANTIÄI: MÄ°KROFON ===

        async function toggleListening() {
            if (isListening) {
                stopProcessing();
            } else {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    sourceNode = audioContext.createMediaStreamSource(stream);
                    analyser = audioContext.createAnalyser();
                    
                    updateLiveFftSize(); // CanlÄ± akÄ±ÅŸ iÃ§in FFT'yi ayarla

                    sourceNode.connect(analyser);
                    
                    isListening = true;
                    startStopButton.textContent = "ğŸ›‘ Durdur";
                    startStopButton.classList.add("stop-mode"); // YENÄ°: Stil iÃ§in
                    captureButton.disabled = false;
                    
                    drawLiveWave(); 
                } catch (err) {
                    console.error('Mikrofon hatasÄ±:', err);
                    alert("Mikrofon hatasÄ±: " + err.message + "\n\n(Bu kod 'localhost' veya 'https' gerektirir.)");
                }
            }
        }

        function stopProcessing() {
             if (liveAnimationId) {
                cancelAnimationFrame(liveAnimationId);
                liveAnimationId = null;
            }
            if (audioContext && audioContext.state !== 'closed') {
                if (sourceNode) {
                    sourceNode.mediaStream.getTracks().forEach(track => track.stop());
                }
                audioContext.close().catch(e => console.error(e));
                audioContext = null;
            }
            isListening = false;
            startStopButton.textContent = "ğŸ™ï¸ Mikrofonu BaÅŸlat";
            startStopButton.classList.remove("stop-mode"); // YENÄ°: Stil iÃ§in
            captureButton.disabled = true;
            drawGrid(liveCtx, "AkÄ±ÅŸ Durdu. BaÅŸlat'a bas.");
        }

        function updateLiveFftSize() {
            currentLiveFftSize = fftMap[fftSlider.value];
            if (analyser) {
                analyser.fftSize = currentLiveFftSize;
                liveDataArray = new Float32Array(analyser.frequencyBinCount);
            }
            liveInfo.textContent = `Detay (FFT): ${currentLiveFftSize}`;
        }
        
        function captureAudio() {
            if (!isListening || !analyser) return;
            
            try {
                analyser.fftSize = CAPTURE_BUFFER_SIZE * 2;
                analyser.getFloatTimeDomainData(capturedDataBuffer); 
            } catch(e) {
                console.error("FFT hatasÄ±:", e);
            } finally {
                analyser.fftSize = currentLiveFftSize;
            }
            
            const totalTimeMs = (CAPTURE_BUFFER_SIZE / audioContext.sampleRate) * 1000;
            analysisInfo.textContent = `Toplam Yakalanan SÃ¼re: ${totalTimeMs.toFixed(1)} ms`;

            scrollSlider.max = CAPTURE_BUFFER_SIZE - ANALYSIS_VIEW_WIDTH;
            scrollSlider.value = 0;
            analysisOffset = 0;

            drawAnalysisWave();
        }

        // === 4. GÃ–RSELLEÅTÄ°RME VE Ã‡Ä°ZÄ°M ===
        
        function drawLiveWave() {
            if (!isListening) return;
            liveAnimationId = requestAnimationFrame(drawLiveWave);
            
            analyser.getFloatTimeDomainData(liveDataArray);

            liveCtx.fillStyle = '#000'; // Kanvas arka planÄ±
            liveCtx.fillRect(0, 0, liveCanvas.width, liveCanvas.height);
            drawGrid(liveCtx);
            liveCtx.lineWidth = 2;
            liveCtx.strokeStyle = LIVE_WAVE_RENK; // YENÄ°: CSS DeÄŸiÅŸkeni
            liveCtx.beginPath();

            const sliceWidth = liveCanvas.width * 1.0 / liveDataArray.length;
            let x = 0;

            for (let i = 0; i < liveDataArray.length; i++) {
                const v = liveDataArray[i];
                const y = (v * liveCanvas.height / 2) + (liveCanvas.height / 2);

                if (i === 0) liveCtx.moveTo(x, y);
                else liveCtx.lineTo(x, y);
                x += sliceWidth;
            }
            liveCtx.lineTo(liveCanvas.width, liveCanvas.height / 2);
            liveCtx.stroke();
        }

        function drawAnalysisWave() {
            analysisCtx.fillStyle = '#000';
            analysisCtx.fillRect(0, 0, analysisCanvas.width, analysisCanvas.height);
            drawGrid(analysisCtx, "Ä°ncelemek iÃ§in tÄ±kla");

            // 1. Ana Yakalanan Ses DalgasÄ±
            analysisCtx.lineWidth = 2;
            analysisCtx.strokeStyle = CAPTURED_WAVE_RENK; // YENÄ°: CSS DeÄŸiÅŸkeni
            analysisCtx.beginPath();

            const sliceWidth = analysisCanvas.width * 1.0 / ANALYSIS_VIEW_WIDTH; 
            let x = 0;

            for (let i = 0; i < ANALYSIS_VIEW_WIDTH; i++) {
                const dataIndex = analysisOffset + i; 
                if (dataIndex >= capturedDataBuffer.length) break;

                const v = capturedDataBuffer[dataIndex];
                const y = (v * analysisCanvas.height / 2) + (analysisCanvas.height / 2);

                if (i === 0) analysisCtx.moveTo(x, y);
                else analysisCtx.lineTo(x, y);
                x += sliceWidth;
            }
            analysisCtx.lineTo(analysisCanvas.width, analysisCanvas.height / 2);
            analysisCtx.stroke();

            // 2. Referans sinÃ¼s dalgasÄ± (varsa)
            if (showRefWaveCheck.checked) {
                drawReferenceSineWave();
            }
        }
        
        function drawReferenceSineWave() {
            const freq = parseFloat(freqSlider.value);
            const amp = parseFloat(ampSlider.value);
            
            analysisCtx.lineWidth = 1.5; // Biraz daha belirgin
            analysisCtx.strokeStyle = REF_WAVE_RENK; // YENÄ°: CSS DeÄŸiÅŸkeni
            analysisCtx.beginPath();
            
            const sliceWidth = analysisCanvas.width * 1.0 / ANALYSIS_VIEW_WIDTH;
            let x = 0;

            for (let i = 0; i < ANALYSIS_VIEW_WIDTH; i++) {
                const t = i / ANALYSIS_VIEW_WIDTH; 
                const v = amp * Math.sin(2 * Math.PI * freq * t);
                const y = (v * analysisCanvas.height / 2) + (analysisCanvas.height / 2);
                
                if (i === 0) analysisCtx.moveTo(x, y);
                else analysisCtx.lineTo(x, y);
                x += sliceWidth;
            }
            analysisCtx.stroke();
            
            // YENÄ° ESTETÄ°K: Referans dalga bilgisini HTML olarak gÃ¼ncelle
            const periyot = 1 / freq;
            refWaveDataPre.innerHTML = `
<span class="label">Ayarlar:</span>
  <span class="label">Frekans (f):</span> <span class="value-emphasis">${freq.toFixed(1)} (DÃ¶ngÃ¼/Ekran)</span>
  <span class="label">Genlik (A):</span>  <span class="value-emphasis">${amp.toFixed(2)}</span>

<span class="label">Hesaplamalar:</span>
  <span class="label">Periyot (T):</span> <span class="value-emphasis">${periyot.toFixed(3)} (Ekran GeniÅŸliÄŸi / f)</span>
  
<span class="label">Dalga Denklemi:</span>
  <span class="label">y(t) = ${amp.toFixed(2)} * sin(2 * Ï€ * ${freq.toFixed(1)} * t)</span>
            `;
        }

        function drawGrid(ctx, message = null) {
            const w = ctx.canvas.width;
            const h = ctx.canvas.height;
            
            ctx.lineWidth = 1;
            ctx.strokeStyle = GRID_RENK_IKINCIL; // YENÄ°: CSS DeÄŸiÅŸkeni
            
            for (let x = 0; x < w; x += 50) {
                ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, h); ctx.stroke();
            }
            for (let y = 0; y < h; y += 50) {
                ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(w, y); ctx.stroke();
            }
            
            ctx.strokeStyle = GRID_RENK_ANA; // YENÄ°: CSS DeÄŸiÅŸkeni
            ctx.beginPath(); ctx.moveTo(0, h / 2); ctx.lineTo(w, h / 2); ctx.stroke();
            
            if (message) {
                ctx.fillStyle = "rgba(255, 255, 255, 0.7)";
                ctx.textAlign = "center";
                ctx.font = "16px 'Open Sans'";
                ctx.fillText(message, w / 2, h / 2 - 20);
            }
        }

        // === 5. TRÄ°GONOMETRÄ°K HESAPLAMA (EÄÄ°M/HIZ) ===

        function analyzeClick(event) {
            const rect = analysisCanvas.getBoundingClientRect();
            const x = event.clientX - rect.left;

            // X koordinatÄ±nÄ± GÃ–RÃœNÃœMDEKÄ° index'e Ã§evir
            const viewIndex = Math.round((x / analysisCanvas.width) * ANALYSIS_VIEW_WIDTH);
            
            const bufferIndex = analysisOffset + viewIndex;

            if (!capturedDataBuffer || capturedDataBuffer[0] === 0 || bufferIndex >= CAPTURE_BUFFER_SIZE || bufferIndex < 1 || !audioContext) {
                alert("LÃ¼tfen Ã¶nce 'AnlÄ±k Ses Yakala' butonuna basÄ±n.");
                return; 
            }

            const y_val = capturedDataBuffer[bufferIndex];
            const y_prev = capturedDataBuffer[bufferIndex - 1];
            const y_next = capturedDataBuffer[bufferIndex + 1];

            const slope_m = (y_next - y_prev) / 2.0;

            const angle_rad = Math.atan(slope_m);
            const angle_deg = angle_rad * (180 / Math.PI);
            const sin_val = Math.sin(angle_rad);
            const cos_val = Math.cos(angle_rad);
            const cot_val = 1.0 / slope_m; 
            
            const totalTimeMs = (CAPTURE_BUFFER_SIZE / audioContext.sampleRate) * 1000;
            const clickTimeMs = (bufferIndex / CAPTURE_BUFFER_SIZE) * totalTimeMs;

            // YENÄ° ESTETÄ°K: SonuÃ§larÄ± HTML olarak yazdÄ±r
            analysisDataPre.innerHTML = `
<span class="label">TÄ±kladÄ±ÄŸÄ±n Nokta:</span>
  <span class="label">Zaman (t):</span>  <span class="value">${clickTimeMs.toFixed(2)} ms</span>
  <span class="label">Genlik (y):</span> <span class="value">${y_val.toFixed(4)}</span>

<span class="label">Nokta EÄŸim (TeÄŸet) Bilgileri:</span>
  <span class="label">EÄŸim (m) - **AKIÅ HIZI**:</span> <span class="value-emphasis">${slope_m.toFixed(4)}</span>
  <span class="label">AÃ§Ä± (Î¸) [Radyan]:</span>       <span class="value">${angle_rad.toFixed(4)}</span>
  <span class="label">AÃ§Ä± (Î¸) [Derece]:</span>       <span class="value">${angle_deg.toFixed(2)}Â°</span>

<span class="label">Trigonometrik DeÄŸerler:</span>
  <span class="label">tan(Î¸):</span> <span class="value">${slope_m.toFixed(4)}</span>
  <span class="label">sin(Î¸):</span> <span class="value">${sin_val.toFixed(4)}</span>
  <span class="label">cos(Î¸):</span> <span class="value">${cos_val.toFixed(4)}</span>
  <span class="label">cot(Î¸):</span> <span class="value">${cot_val.toFixed(4)}</span>
            `;

            drawAnalysisWave(); // Ana dalgayÄ± tekrar Ã§iz
            // TÄ±klanan noktayÄ± iÅŸaretle
            analysisCtx.fillStyle = 'red';
            analysisCtx.beginPath();
            const canvas_y = (y_val * analysisCanvas.height / 2) + (analysisCanvas.height / 2);
            analysisCtx.arc(x, canvas_y, 5, 0, 2 * Math.PI); // x'i (tÄ±klanan yeri) kullan
            analysisCtx.fill();
        }

        // === 6. OLAY DÄ°NLEYÄ°CÄ°LERÄ° VE AKORDÄ°YON ===
        
        startStopButton.addEventListener('click', toggleListening);
        captureButton.addEventListener('click', captureAudio);
        analysisCanvas.addEventListener('click', analyzeClick);
        
        fftSlider.addEventListener('input', updateLiveFftSize);

        scrollSlider.addEventListener('input', (e) => {
            analysisOffset = parseInt(e.target.value);
            if (capturedDataBuffer[0] !== 0) drawAnalysisWave(); 
        });

        [showRefWaveCheck, freqSlider, ampSlider].forEach(el => el.addEventListener('input', () => {
             if (capturedDataBuffer[0] !== 0) drawAnalysisWave();
             // Sadece referans bilgisini gÃ¼ncelle (eÄŸer dalga Ã§izilmiyorsa bile)
             else if (showRefWaveCheck.checked) drawReferenceSineWave();
        }));

        document.querySelectorAll(".accordion").forEach(button => {
            button.addEventListener("click", function() {
                this.classList.toggle("active");
                const panel = this.nextElementSibling;
                if (panel.style.maxHeight) {
                    panel.style.maxHeight = null;
                } else {
                    panel.style.maxHeight = panel.scrollHeight + "px";
                } 
            });
        });

        // Sayfa yÃ¼klendiÄŸinde ve yeniden boyutlandÄ±rÄ±ldÄ±ÄŸÄ±nda
        window.addEventListener('load', resizeCanvases);
        window.addEventListener('resize', resizeCanvases);

    </script>
</body>
</html>
