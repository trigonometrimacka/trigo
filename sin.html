<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Osiloskop ve Trigonometrik Analiz (WAV Ä°ndirme Eklendi)</title>
    
    <style>
        :root {
            --ana-renk: #32CD32; /* Orta Bahar YeÅŸili */
            --arka-plan: #121212;
            --kutu-arka-plan: #1e1e1e;
            --kutu-kenar: #3e3e3e;
            --metin-rengi: #f0f0f0;
            --koyu-yesil: rgba(50, 205, 50, 0.3);
            --orta-yesil: rgba(50, 205, 50, 0.7);
        }

        body {
            background-color: var(--arka-plan);
            color: var(--metin-rengi);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align: center;
            margin: 0;
            padding: 20px;
        }

        h1, h2, h3 {
            color: var(--ana-renk);
            border-bottom: 2px solid var(--ana-renk);
            padding-bottom: 5px;
            font-weight: 600;
        }

        .layout-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
            max-width: 1250px;
            gap: 20px;
            margin-top: 20px;
            margin-left: auto;
            margin-right: auto;
        }

        .panel {
            background-color: var(--kutu-arka-plan);
            border: 1px solid var(--kutu-kenar);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 600px;
            box-sizing: border-box;
        }

        .kontrol-paneli {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #2a2a2a;
            border-radius: 10px;
            width: 100%;
            max-width: 1250px; /* GeniÅŸletildi */
            box-sizing: border-box;
            margin-left: auto;
            margin-right: auto;
        }

        .kontrol-paneli button {
            background-color: var(--ana-renk);
            color: var(--arka-plan);
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.2s;
            margin: 5px;
        }

        .kontrol-paneli button:hover {
            background-color: #2aa32a;
        }
        
        .kontrol-paneli button:disabled {
            background-color: #555;
            color: #999;
            cursor: not-allowed;
        }
        
        /* YENÄ° Ä°NDÄ°RME BUTONU Ä°Ã‡Ä°N Ã–ZEL STÄ°L */
        #downloadButton {
             background-color: #007BFF; /* Mavi */
             color: white;
        }
        #downloadButton:hover {
             background-color: #0056b3;
        }
        #downloadButton:disabled {
            background-color: #555;
            color: #999;
        }


        canvas {
            background-color: #000;
            border: 2px solid var(--ana-renk);
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            margin-top: 10px;
        }

        #analysisCanvas {
            cursor: crosshair;
        }

        #trigPanel {
            font-family: 'Consolas', 'Courier New', monospace;
            padding: 15px;
            background-color: #1a1a1a;
            border: 1px dashed var(--ana-renk);
            color: #d0d0d0;
            margin-top: 15px;
        }
        
        #trigPanel pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* AKORDÄ°YON (Ã‡alÄ±ÅŸma MantÄ±ÄŸÄ±) STÄ°LÄ° */
        .accordion {
            background-color: #333;
            color: var(--ana-renk);
            cursor: pointer;
            padding: 18px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 1.1em;
            transition: 0.4s;
            margin-top: 10px;
            border-radius: 5px;
            font-weight: bold;
        }

        .active, .accordion:hover {
            background-color: #444;
        }

        .accordion::before {
            content: '+';
            font-weight: bold;
            color: white;
            float: right;
            margin-left: 5px;
        }

        .active::before {
            content: "âˆ’";
        }

        .accordion-panel {
            padding: 0 18px;
            background-color: var(--kutu-arka-plan);
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
            border-left: 3px solid var(--ana-renk);
            border-bottom: 1px solid var(--kutu-kenar);
        }
        .accordion-panel p, .accordion-panel ol {
            line-height: 1.6;
        }

        /* ESTETÄ°K KAYDIRMA Ã‡UBUÄU (SLIDER) STÄ°LÄ° */
        .slider-grup {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid var(--kutu-kenar);
        }
        
        .slider-grup label {
            font-size: 0.9em;
            color: #ccc;
        }
        
        .slider-grup input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 10px;
            border-radius: 5px;
            background: #444;
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
            margin-top: 10px;
        }

        .slider-grup input[type="range"]:hover {
            opacity: 1;
        }

        .slider-grup input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--ana-renk);
            border: 3px solid var(--arka-plan);
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            cursor: pointer;
        }

        .slider-grup input[type="range"]::-moz-range-thumb {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--ana-renk);
            border: 3px solid var(--arka-plan);
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            cursor: pointer;
        }
        
        .slider-etiket-konteyner {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: #aaa;
        }
        
        .osiloskop-bilgi {
            font-family: 'Consolas', monospace;
            color: var(--ana-renk);
            background: #000;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9em;
            text-align: right;
            margin-top: 5px;
        }

    </style>
</head>
<body>

    <div class="kontrol-paneli">
        <button id="startStopButton">ğŸ™ï¸ Mikrofonu BaÅŸlat</button>
        <button id="captureButton" disabled>ğŸ“¸ AnlÄ±k Ses Yakala (Analiz Et)</button>
        <button id="downloadButton" disabled>ğŸ’¾ Yakalanan Sesi Ä°ndir (.wav)</button>
    </div>

    <div class="layout-container">
        <div class="panel">
            <h2>CanlÄ± AkÄ±ÅŸ</h2>
            <div class="osiloskop-bilgi" id="liveInfo">Detay: 2048</div>
            <canvas id="liveCanvas"></canvas>
            <div class="slider-grup">
                <label for="fftSlider">CanlÄ± Dalga DetayÄ± (FFT Boyutu)</label>
                <input type="range" id="fftSlider" min="0" max="5" value="2">
                <div class="slider-etiket-konteyner">
                    <span>HÄ±zlÄ± / Az Detay</span>
                    <span>YavaÅŸ / Ã‡ok Detay</span>
                </div>
            </div>
        </div>

        <div class="panel">
            <h2>Analiz EkranÄ±</h2>
            <div class="osiloskop-bilgi" id="analysisInfo">Toplam Yakalanan SÃ¼re: --- ms</div>
            <canvas id="analysisCanvas"></canvas>
            
            <div class="slider-grup">
                <label for="scrollSlider">Yakalanan Sesi KaydÄ±r (Ä°leri/Geri Sar)</label>
                <input type="range" id="scrollSlider" min="0" max="1000" value="0">
            </div>

            <div class="slider-grup">
                <label>
                    <input type="checkbox" id="showRefWave"> Referans SinÃ¼s DalgasÄ±nÄ± GÃ¶ster
                </label>
                <div style="display: flex; gap: 20px; margin-top: 10px;">
                    <div style="flex-basis: 50%;">
                        <label for="freqSlider">Frekans (DÃ¶ngÃ¼ SayÄ±sÄ±)</label>
                        <input type="range" id="freqSlider" min="1" max="50" value="5">
                    </div>
                    <div style="flex-basis: 50%;">
                        <label for="ampSlider">Genlik (YÃ¼kseklik)</label>
                        <input type="range" id="ampSlider" min="0" max="1" value="0.5" step="0.01">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="panel" id="trigPanel" style="max-width: 1250px; margin-left: auto; margin-right: auto;">
        <div style="display: flex; flex-wrap: wrap; gap: 20px;">
            <div style="flex: 1; min-width: 300px;">
                <h3>ğŸ“‰ Noktasal AkÄ±ÅŸ HÄ±zÄ± (EÄŸim)</h3>
                <pre id="analysisData">
TÄ±kladÄ±ÄŸÄ±n Nokta:
  Zaman (t): ---
  Genlik (y): ---

Nokta EÄŸim (TeÄŸet) Bilgileri:
  EÄŸim (m) - **AKIÅ HIZI**: ---
  AÃ§Ä± (Î¸) [Radyan]: ---
  AÃ§Ä± (Î¸) [Derece]: ---

Trigonometrik DeÄŸerler:
  tan(Î¸) = EÄŸim (m)
  sin(Î¸) = ---
  cos(Î¸) = ---
  cot(Î¸) = ---
                </pre>
            </div>
            <div style="flex: 1; min-width: 300px;">
                <h3>ğŸ§® Referans Dalga Bilgisi</h3>
                <pre id="refWaveData">
Ayarlar:
  Frekans (f): --- (DÃ¶ngÃ¼/Ekran)
  Genlik (A): ---

Hesaplamalar:
  Periyot (T): --- (Ekran GeniÅŸliÄŸi / f)
  Dalga Denklemi:
    y(t) = A * sin(2 * Ï€ * f * t)
                </pre>
            </div>
        </div>
    </div>

    <script>
        "use strict";

        // === 1. DOM ELEMANLARI ve AYARLAR ===
        const ANA_RENK = "#32CD32"; 
        const startStopButton = document.getElementById('startStopButton'); // DÃœZELTME: ID'yi 'startButton' deÄŸil 'startStopButton' olarak aldÄ±m (HTML'deki ile eÅŸleÅŸti)
        const captureButton = document.getElementById('captureButton');
        const downloadButton = document.getElementById('downloadButton'); // YENÄ°: Ä°ndirme butonu
        const liveCanvas = document.getElementById('liveCanvas');
        const analysisCanvas = document.getElementById('analysisCanvas');
        const analysisDataPre = document.getElementById('analysisData');
        const refWaveDataPre = document.getElementById('refWaveData');
        const fftSlider = document.getElementById('fftSlider');
        const liveInfo = document.getElementById('liveInfo');
        const analysisInfo = document.getElementById('analysisInfo');
        
        // Analiz KaydÄ±raÃ§larÄ±
        const scrollSlider = document.getElementById('scrollSlider');
        const showRefWaveCheck = document.getElementById('showRefWave');
        const freqSlider = document.getElementById('freqSlider');
        const ampSlider = document.getElementById('ampSlider');
        
        const liveCtx = liveCanvas.getContext('2d');
        const analysisCtx = analysisCanvas.getContext('2d');

        // === 2. DEÄÄ°ÅKENLER ===
        let audioContext;
        let analyser;
        let sourceNode; // Mikrofon kaynaÄŸÄ±
        let liveDataArray; // CanlÄ± akÄ±ÅŸ iÃ§in (Float32)
        
        const CAPTURE_BUFFER_SIZE = 8192; // Yakalanacak toplam Ã¶rnek (sabit)
        const ANALYSIS_VIEW_WIDTH = 2048; // Ekranda bir anda gÃ¶sterilecek Ã¶rnek (sabit)
        let capturedDataBuffer = new Float32Array(CAPTURE_BUFFER_SIZE); // TÃ¼m yakalanan ses
        let analysisOffset = 0; // KaydÄ±rma Ã§ubuÄŸundan gelen kayma miktarÄ±

        let liveAnimationId;
        let isListening = false;
        
        const fftMap = [512, 1024, 2048, 4096, 8192, 16384];
        let currentLiveFftSize = fftMap[fftSlider.value]; 
        
        const canvasWidth = 600;
        const canvasHeight = 200;
        [liveCanvas, analysisCanvas].forEach(c => {
            c.width = canvasWidth;
            c.height = canvasHeight;
        });

        // === 3. Ã‡ALIÅMA MANTIÄI: MÄ°KROFON ===

        async function toggleListening() {
            if (isListening) {
                stopProcessing();
            } else {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    sourceNode = audioContext.createMediaStreamSource(stream);
                    analyser = audioContext.createAnalyser();
                    
                    updateLiveFftSize(); // CanlÄ± akÄ±ÅŸ iÃ§in FFT'yi ayarla

                    sourceNode.connect(analyser);
                    
                    isListening = true;
                    startStopButton.textContent = "ğŸ›‘ Durdur";
                    captureButton.disabled = false;
                    downloadButton.disabled = true; // YENÄ°: BaÅŸlangÄ±Ã§ta indirme butonu pasif
                    
                    drawLiveWave(); 
                } catch (err) {
                    console.error('Mikrofon hatasÄ±:', err);
                    alert("Mikrofon hatasÄ±: " + err.message + "\n\n(Bu kod 'localhost' veya 'https' gerektirir.)");
                }
            }
        }

        function stopProcessing() {
             if (liveAnimationId) {
                cancelAnimationFrame(liveAnimationId);
                liveAnimationId = null;
            }
            if (audioContext && audioContext.state !== 'closed') {
                if (sourceNode) {
                    sourceNode.mediaStream.getTracks().forEach(track => track.stop());
                }
                audioContext.close().catch(e => console.error(e));
                audioContext = null;
            }
            isListening = false;
            startStopButton.textContent = "ğŸ™ï¸ Mikrofonu BaÅŸlat";
            captureButton.disabled = true;
            downloadButton.disabled = true; // YENÄ°: Durunca indirme butonu pasif
            drawGrid(liveCtx, "AkÄ±ÅŸ Durdu. BaÅŸlat'a bas.");
        }

        // CanlÄ± akÄ±ÅŸÄ±n detayÄ±nÄ±/hÄ±zÄ±nÄ± gÃ¼nceller
        function updateLiveFftSize() {
            currentLiveFftSize = fftMap[fftSlider.value];
            if (analyser) {
                analyser.fftSize = currentLiveFftSize;
                liveDataArray = new Float32Array(analyser.frequencyBinCount); // frequencyBinCount = fftSize / 2
            }
            liveInfo.textContent = `Detay (FFT): ${currentLiveFftSize}`;
        }
        
        // AnlÄ±k Sesi Yakala Fonksiyonu
        function captureAudio() {
            if (!isListening || !analyser) return;
            
            // GeÃ§ici olarak FFT boyutunu YÃœKSELT (daha fazla veri yakalamak iÃ§in)
            try {
                analyser.fftSize = CAPTURE_BUFFER_SIZE * 2; // (frequencyBinCount = fftSize / 2)
                // Veriyi yakala
                analyser.getFloatTimeDomainData(capturedDataBuffer); 
            } catch(e) {
                console.error("FFT hatasÄ±:", e);
            } finally {
                // CanlÄ± akÄ±ÅŸ iÃ§in FFT boyutunu HEMEN geri ayarla
                analyser.fftSize = currentLiveFftSize;
            }
            
            // Yakalanan toplam sÃ¼reyi hesapla ve ekrana yaz
            const totalTimeMs = (CAPTURE_BUFFER_SIZE / audioContext.sampleRate) * 1000;
            analysisInfo.textContent = `Toplam Yakalanan SÃ¼re: ${totalTimeMs.toFixed(1)} ms`;

            // KaydÄ±rma Ã§ubuÄŸunu ayarla (Maksimum kaydÄ±rma miktarÄ±)
            scrollSlider.max = CAPTURE_BUFFER_SIZE - ANALYSIS_VIEW_WIDTH;
            scrollSlider.value = 0;
            analysisOffset = 0;

            // Analiz ekranÄ±nÄ± Ã§iz
            drawAnalysisWave();
            
            // YENÄ°: Ä°ndirme butonunu aktifleÅŸtir
            downloadButton.disabled = false;
        }

        // === 4. GÃ–RSELLEÅTÄ°RME VE Ã‡Ä°ZÄ°M ===
        
        // CanlÄ± dalgayÄ± Ã§izen dÃ¶ngÃ¼ (Float32 verisi ile)
        function drawLiveWave() {
            if (!isListening) return;
            liveAnimationId = requestAnimationFrame(drawLiveWave);
            
            analyser.getFloatTimeDomainData(liveDataArray); // Float veri (-1.0 ile 1.0 arasÄ±)

            liveCtx.fillStyle = 'rgb(0, 0, 0)';
            liveCtx.fillRect(0, 0, canvasWidth, canvasHeight);
            drawGrid(liveCtx);
            liveCtx.lineWidth = 2;
            liveCtx.strokeStyle = ANA_RENK; 
            liveCtx.beginPath();

            const sliceWidth = canvasWidth * 1.0 / liveDataArray.length;
            let x = 0;

            for (let i = 0; i < liveDataArray.length; i++) {
                const v = liveDataArray[i]; // Veri zaten -1 ile 1 arasÄ±nda
                const y = (v * canvasHeight / 2) + (canvasHeight / 2); // Koordianata Ã§evir

                if (i === 0) liveCtx.moveTo(x, y);
                else liveCtx.lineTo(x, y);
                x += sliceWidth;
            }
            liveCtx.lineTo(canvasWidth, canvasHeight / 2);
            liveCtx.stroke();
        }

        // Yakalanan (dondurulmuÅŸ) dalgayÄ± Ã§izen fonksiyon
        function drawAnalysisWave() {
            analysisCtx.fillStyle = 'rgb(0, 0, 0)';
            analysisCtx.fillRect(0, 0, canvasWidth, canvasHeight);
            drawGrid(analysisCtx, "Ä°ncelemek iÃ§in tÄ±kla");

            // 1. Ana Yakalanan Ses DalgasÄ± (Ä°leri/Geri Sarma Ã¶zellikli)
            analysisCtx.lineWidth = 2;
            analysisCtx.strokeStyle = 'rgb(255, 165, 0)'; // Turuncu-SarÄ±
            analysisCtx.beginPath();

            // Sadece ANALYSIS_VIEW_WIDTH (2048) kadar Ã¶rnek Ã§iz
            const sliceWidth = canvasWidth * 1.0 / ANALYSIS_VIEW_WIDTH; 
            let x = 0;

            for (let i = 0; i < ANALYSIS_VIEW_WIDTH; i++) {
                // KaydÄ±rma miktarÄ± (offset) + o anki index
                const dataIndex = analysisOffset + i; 
                if (dataIndex >= capturedDataBuffer.length) break;

                const v = capturedDataBuffer[dataIndex];
                const y = (v * canvasHeight / 2) + (canvasHeight / 2);

                if (i === 0) analysisCtx.moveTo(x, y);
                else analysisCtx.lineTo(x, y);
                x += sliceWidth;
            }
            analysisCtx.lineTo(canvasWidth, canvasHeight / 2);
            analysisCtx.stroke();

            // 2. Referans sinÃ¼s dalgasÄ± (varsa)
            if (showRefWaveCheck.checked) {
                drawReferenceSineWave();
            }
        }
        
        // Tam KontrollÃ¼ Referans SinÃ¼s DalgasÄ±
        function drawReferenceSineWave() {
            const freq = parseFloat(freqSlider.value); // DÃ¶ngÃ¼ SayÄ±sÄ±
            const amp = parseFloat(ampSlider.value); // Genlik (0.0 - 1.0)
            
            analysisCtx.lineWidth = 1;
            analysisCtx.strokeStyle = 'rgb(255, 0, 255)'; // Pembe (referans)
            analysisCtx.beginPath();
            
            const sliceWidth = canvasWidth * 1.0 / ANALYSIS_VIEW_WIDTH;
            let x = 0;

            for (let i = 0; i < ANALYSIS_VIEW_WIDTH; i++) {
                // t = 0'dan 1'e giden gÃ¶receli zaman (ekran boyunca)
                const t = i / ANALYSIS_VIEW_WIDTH; 
                const v = amp * Math.sin(2 * Math.PI * freq * t);
                const y = (v * canvasHeight / 2) + (canvasHeight / 2);
                
                if (i === 0) analysisCtx.moveTo(x, y);
                else analysisCtx.lineTo(x, y);
                x += sliceWidth;
            }
            analysisCtx.stroke();
            
            // Referans dalga bilgisini gÃ¼ncelle
            const periyot = 1 / freq;
            refWaveDataPre.textContent = `
Ayarlar:
  Frekans (f): ${freq.toFixed(1)} (DÃ¶ngÃ¼/Ekran)
  Genlik (A): ${amp.toFixed(2)}

Hesaplamalar:
  Periyot (T): ${periyot.toFixed(3)} (Ekran GeniÅŸliÄŸi / f)
  Dalga Denklemi:
    y(t) = ${amp.toFixed(2)} * sin(2 * Ï€ * ${freq.toFixed(1)} * t)
            `;
        }

        // Izgara Ã‡izim Fonksiyonu
        function drawGrid(ctx, message = null) {
            ctx.lineWidth = 1;
            ctx.strokeStyle = 'rgba(50, 205, 50, 0.3)'; 
            for (let x = 0; x < canvasWidth; x += 50) {
                ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvasHeight); ctx.stroke();
            }
            for (let y = 0; y < canvasHeight; y += 50) {
                ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvasWidth, y); ctx.stroke();
            }
            ctx.strokeStyle = 'rgba(50, 205, 50, 0.7)';
            ctx.beginPath(); ctx.moveTo(0, canvasHeight / 2); ctx.lineTo(canvasWidth, canvasHeight / 2); ctx.stroke();
            if (message) {
                ctx.fillStyle = "rgba(255, 255, 255, 0.7)";
                ctx.textAlign = "center";
                ctx.font = "16px 'Segoe UI'";
                ctx.fillText(message, canvasWidth / 2, canvasHeight / 2 - 20);
            }
        }

        // === 5. TRÄ°GONOMETRÄ°K HESAPLAMA (EÄÄ°M/HIZ) ===

        function analyzeClick(event) {
            const rect = analysisCanvas.getBoundingClientRect();
            const x = event.clientX - rect.left;

            // X koordinatÄ±nÄ± GÃ–RÃœNÃœMDEKÄ° index'e Ã§evir
            const viewIndex = Math.round((x / canvasWidth) * ANALYSIS_VIEW_WIDTH);
            
            // GerÃ§ek Ana Tampon (Buffer) Index'ini bul (KaydÄ±rmayÄ± hesaba kat)
            const bufferIndex = analysisOffset + viewIndex;

            if (!capturedDataBuffer || capturedDataBuffer[0] === 0 || bufferIndex >= CAPTURE_BUFFER_SIZE || bufferIndex < 1) {
                alert("LÃ¼tfen Ã¶nce 'AnlÄ±k Ses Yakala' butonuna basÄ±n.");
                return; 
            }

            // DeÄŸerleri Ana Tampondan al
            const y_val = capturedDataBuffer[bufferIndex];
            const y_prev = capturedDataBuffer[bufferIndex - 1];
            const y_next = capturedDataBuffer[bufferIndex + 1];

            // EÄÄ°M (HÄ±z) HESAPLAMA
            const slope_m = (y_next - y_prev) / 2.0;

            // TRÄ°G HESAPLAMALARI
            const angle_rad = Math.atan(slope_m);
            const angle_deg = angle_rad * (180 / Math.PI);
            const sin_val = Math.sin(angle_rad);
            const cos_val = Math.cos(angle_rad);
            const cot_val = 1.0 / slope_m; 
            
            // Yakalanan toplam sÃ¼reyi bil
            const totalTimeMs = (CAPTURE_BUFFER_SIZE / audioContext.sampleRate) * 1000;
            // TÄ±kladÄ±ÄŸÄ±n anÄ±n gerÃ§ek zamanÄ±nÄ± (ms) hesapla
            const clickTimeMs = (bufferIndex / CAPTURE_BUFFER_SIZE) * totalTimeMs;

            // SonuÃ§larÄ± ekrana yazdÄ±r
            analysisDataPre.textContent = `
TÄ±kladÄ±ÄŸÄ±n Nokta:
  Zaman (t): ${clickTimeMs.toFixed(2)} ms
  Genlik (y): ${y_val.toFixed(4)}

Nokta EÄŸim (TeÄŸet) Bilgileri:
  EÄŸim (m) - **AKIÅ HIZI**: ${slope_m.toFixed(4)}
  AÃ§Ä± (Î¸) [Radyan]: ${angle_rad.toFixed(4)}
  AÃ§Ä± (Î¸) [Derece]: ${angle_deg.toFixed(2)}

Trigonometrik DeÄŸerler:
  tan(Î¸) = ${slope_m.toFixed(4)}
  sin(Î¸) = ${sin_val.toFixed(4)}
  cos(Î¸) = ${cos_val.toFixed(4)}
  cot(Î¸) = ${cot_val.toFixed(4)}
            `;

            drawAnalysisWave(); // Ana dalgayÄ± tekrar Ã§iz
            // TÄ±klanan noktayÄ± iÅŸaretle
            analysisCtx.fillStyle = 'red';
            analysisCtx.beginPath();
            const canvas_y = (y_val * canvasHeight / 2) + (canvasHeight / 2);
            analysisCtx.arc(x, canvas_y, 5, 0, 2 * Math.PI); // x'i (tÄ±klanan yeri) kullan
            analysisCtx.fill();
        }

        // === 6. YENÄ°: WAV Ä°NDÄ°RME FONKSÄ°YONLARI ===

        function exportWAV() {
            if (!capturedDataBuffer || capturedDataBuffer[0] === 0 || !audioContext) {
                alert("Ä°ndirilecek yakalanmÄ±ÅŸ ses verisi yok.");
                return;
            }
            
            const sampleRate = audioContext.sampleRate;
            const wavBuffer = encodeWAV(capturedDataBuffer, sampleRate);
            const blob = new Blob([wavBuffer], { type: 'audio/wav' });
            
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `osiloskop_yakalama_${new Date().getTime()}.wav`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
        }

        function encodeWAV(samples, sampleRate) {
            // Float32'yi 16-bit PCM'ye dÃ¶nÃ¼ÅŸtÃ¼r
            const pcmSamples = new Int16Array(samples.length);
            for (let i = 0; i < samples.length; i++) {
                let s = Math.max(-1, Math.min(1, samples[i]));
                pcmSamples[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
            }
            
            const dataSize = pcmSamples.length * 2; // 16 bit = 2 byte
            const fileSize = 44 + dataSize; // 44 byte header
            
            const buffer = new ArrayBuffer(fileSize);
            const view = new DataView(buffer);

            // RIFF chunk
            writeString(view, 0, 'RIFF');
            view.setUint32(4, fileSize - 8, true); // (fileSize - 8)
            writeString(view, 8, 'WAVE');
            
            // "fmt " chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); // chunk size
            view.setUint16(20, 1, true); // audio format (1 = PCM)
            view.setUint16(22, 1, true); // num channels (1 = Mono)
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true); // byte rate (SampleRate * NumChannels * BitsPerSample/8)
            view.setUint16(32, 2, true); // block align (NumChannels * BitsPerSample/8)
            view.setUint16(34, 16, true); // bits per sample
            
            // "data" chunk
            writeString(view, 36, 'data');
            view.setUint32(40, dataSize, true);
            
            // Veriyi (PCM) yaz
            let offset = 44;
            for (let i = 0; i < pcmSamples.length; i++, offset += 2) {
                view.setInt16(offset, pcmSamples[i], true);
            }
            
            return buffer;
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        // === 7. OLAY DÄ°NLEYÄ°CÄ°LERÄ° VE AKORDÄ°YON ===
        
        startStopButton.addEventListener('click', toggleListening);
        captureButton.addEventListener('click', captureAudio);
        downloadButton.addEventListener('click', exportWAV); // YENÄ°: Ä°ndirme listener'Ä±
        analysisCanvas.addEventListener('click', analyzeClick);
        
        // CanlÄ± dalga hÄ±zÄ± kaydÄ±racÄ±nÄ± dinle
        fftSlider.addEventListener('input', updateLiveFftSize);

        // Ä°leri/Geri Sarma KaydÄ±racÄ±nÄ± Dinle
        scrollSlider.addEventListener('input', (e) => {
            analysisOffset = parseInt(e.target.value);
            // Sadece veri varsa yeniden Ã§iz
            if (capturedDataBuffer[0] !== 0) drawAnalysisWave(); 
        });

        // Referans dalga kontrollerini dinle
        [showRefWaveCheck, freqSlider, ampSlider].forEach(el => el.addEventListener('input', () => {
             if (capturedDataBuffer[0] !== 0) drawAnalysisWave();
        }));

        // Akordiyon (Ã‡alÄ±ÅŸma MantÄ±ÄŸÄ±) KontrolÃ¼
        document.querySelectorAll(".accordion").forEach(button => {
            button.addEventListener("click", function() {
                this.classList.toggle("active");
                const panel = this.nextElementSibling;
                if (panel.style.maxHeight) {
                    panel.style.maxHeight = null;
                } else {
                    panel.style.maxHeight = panel.scrollHeight + "px";
                } 
            });
        });

        // Sayfa yÃ¼klendiÄŸinde varsayÄ±lan ekranÄ± Ã§iz
        window.addEventListener('load', () => {
             drawGrid(liveCtx, "BaÅŸlat'a bas.");
             drawGrid(analysisCtx, "Yakalanan ses buraya gelir.");
        });
    </script>
</body>
</html>
